<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Å–ø–æ—Ä—Ç–æ–º –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–û–ø—Ä–æ–±–æ–≤–∞–Ω–∏–µ">

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <title>–ü–∞—Å–ø–æ—Ä—Ç –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω</title>

  <!-- ZXing Barcode Scanner Library -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #667eea;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --bg: #f5f7fa;
      --surface: #ffffff;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--dark);
      line-height: 1.5;
      height: 100vh;
      overflow: hidden;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* HEADER */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
      color: white;
      padding: 16px 20px;
      box-shadow: var(--shadow);
      z-index: 100;
    }

    .header h1 {
      font-size: 20px;
      margin: 0;
    }

    /* MAIN LAYOUT */
    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 16px;
      overflow-y: auto;
    }

    .scanner-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--surface);
      border-radius: 8px;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .scanner-panel h2 {
      font-size: 16px;
      margin: 0 0 12px 0;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 8px;
    }

    .control-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }

    .card {
      background: var(--surface);
      border-radius: 8px;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .card h3 {
      font-size: 14px;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary);
    }

    /* CAMERA */
    .camera-container {
      width: 100%;
      border: 2px solid #ddd;
      border-radius: 8px;
      overflow: hidden;
      background: #000;
      margin-bottom: 12px;
      position: relative;
    }

    #video {
      width: 100%;
      height: 200px;
      object-fit: cover;
      display: block;
    }

    .camera-status {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
    }

    .camera-status.scanning {
      background: rgba(40, 167, 69, 0.95);
      animation: pulse 1.5s infinite;
    }

    .camera-status.inactive {
      background: rgba(100, 100, 100, 0.8);
    }

    .camera-status.error {
      background: rgba(220, 53, 69, 0.95);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* INPUTS */
    .scanner-input {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }

    .scanner-input input,
    .scanner-input select {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    #barcodeInput {
      border: 2px solid #ddd;
      font-weight: 600;
      text-align: center;
    }

    #barcodeInput:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      background: #f0f7ff;
    }

    #barcodeInput.filled {
      border-color: var(--primary);
      background: #f0f7ff;
    }

    .scanner-input button {
      padding: 10px 16px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      flex: 0 0 auto;
    }

    .scanner-input button:active {
      transform: scale(0.95);
      background: #5a67d8;
    }

    .scanner-input button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* RESULT */
    .scanner-result {
      background: #f0f0f0;
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
      min-height: 70px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
      white-space: pre-line;
    }

    .scanner-result.success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid var(--success);
    }

    .scanner-result.error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid var(--danger);
    }

    .scanner-result.info {
      background: #d1ecf1;
      color: #0c5460;
      border-left: 4px solid var(--info);
    }

    /* STATS SMALL */
    .scanner-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 8px;
    }

    .scanner-stat {
      background: var(--light);
      padding: 8px 12px;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
    }

    .scanner-stat strong {
      display: block;
      font-size: 18px;
      color: var(--primary);
      margin-top: 4px;
    }

    /* BUTTONS */
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }

    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:active {
      background: #5a67d8;
      transform: scale(0.98);
    }

    .btn-secondary {
      background: var(--light);
      color: var(--dark);
      border: 1px solid #ddd;
    }

    .btn-secondary:active {
      background: #e9ecef;
    }

    /* TABLE */
    .wells-table {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .wells-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .wells-table thead {
      background: var(--light);
      position: sticky;
      top: 0;
    }

    .wells-table th {
      padding: 6px;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid #ddd;
    }

    .wells-table td {
      padding: 6px;
      border-bottom: 1px solid #ddd;
    }

    .wells-table tr:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    .status-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
    }

    .status-badge.sampled {
      background: #d4edda;
      color: #155724;
    }

    .status-badge.not_sampled {
      background: #fff3cd;
      color: #856404;
    }

    /* SEARCH */
    .search-box {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      width: 100%;
      margin-bottom: 8px;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .filter-select {
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      width: 100%;
      margin-bottom: 8px;
    }

    /* MODALS */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
      position: relative;
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* PROGRESS */
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 8px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #764ba2);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 11px;
      font-weight: 600;
    }

    /* NOTIFICATIONS */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      animation: slideIn 0.3s ease;
      z-index: 999;
    }

    .notification.success {
      background: var(--success);
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.info {
      background: var(--info);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* FOOTER STATS */
    .footer-stats {
      margin: 8px 16px 16px;
    }

    .header-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      font-size: 12px;
    }

    .header-stat {
      background: rgba(255, 255, 255, 0.9);
      padding: 6px 10px;
      border-radius: 4px;
      text-align: center;
    }

    .header-stat span {
      color: #666;
      font-size: 11px;
    }

    .header-stat strong {
      display: block;
      font-size: 16px;
      margin-top: 4px;
      color: #333;
    }

    /* LOADING */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 1024px) {
      .main {
        grid-template-columns: 1fr;
        padding: 12px;
      }
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 16px;
      }

      #video {
        height: 150px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <h1>üìä –ü–∞—Å–ø–æ—Ä—Ç –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω</h1>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
      <!-- LEFT: SCANNER -->
      <div class="scanner-panel">
        <h2>üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>

        <!-- CAMERA -->
        <div class="camera-container">
          <video id="video" playsinline autoplay muted></video>
          <div class="camera-status" id="cameraStatus">üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>

        <!-- SAMPLE (BARCODE / MANUAL) -->
        <div class="scanner-input">
          <input
            type="text"
            id="barcodeInput"
            placeholder="Sample (—à—Ç—Ä–∏—Ö–∫–æ–¥ –∏–ª–∏ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥)"
            autocomplete="off"
          >
          <button id="scanBtn" onclick="processScan()">‚úì –ó–∞–ø–∏—Å–∞—Ç—å</button>
        </div>

        <!-- MANUAL WELL NAME -->
        <div class="scanner-input">
          <input
            type="text"
            id="wellNameInput"
            placeholder="–°–∫–≤–∞–∂–∏–Ω–∞ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)"
            autocomplete="off"
          >
        </div>

        <!-- TYPE + BLOCK -->
        <div class="scanner-input">
          <select id="typeSelect" class="filter-select" style="max-width:120px;">
            <option value="520">520</option>
            <option value="360">360</option>
          </select>
          <input
            type="text"
            id="blockInput"
            placeholder="–ë–ª–æ–∫"
            autocomplete="off"
          >
        </div>

        <!-- RESULT -->
        <div class="scanner-result" id="scanResult">
          –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...
        </div>

        <!-- SMALL STATS -->
        <div class="scanner-stats">
          <div class="scanner-stat">
            <span>–°–µ–≥–æ–¥–Ω—è</span>
            <strong id="scannedToday">0</strong>
          </div>
          <div class="scanner-stat">
            <span>–í—Å–µ–≥–æ</span>
            <strong id="scannedTotal">0</strong>
          </div>
        </div>

        <!-- ACTIONS -->
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showAddWellsModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã</button>
          <button class="btn btn-secondary" onclick="showDuplicatesModal()">üîÑ –î—É–±–ª–∏–∫–∞—Ç—ã</button>
          <button class="btn btn-secondary" onclick="exportToCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
      </div>

      <!-- RIGHT: LIST -->
      <div class="control-panel">
        <div class="card">
          <h3>üîé –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
          <input
            type="text"
            class="search-box"
            id="searchInput"
            placeholder="–ü–æ–∏—Å–∫ –ø–æ Sample –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é..."
            onkeyup="filterWells()"
          >
          <select class="filter-select" id="filterStatus" onchange="filterWells()">
            <option value="all">üìå –í—Å–µ</option>
            <option value="sampled">‚úì –û–ø—Ä–æ–±–æ–≤–∞–Ω—ã</option>
            <option value="not_sampled">‚óã –ù–µ –æ–ø—Ä–æ–±–æ–≤–∞–Ω—ã</option>
          </select>
          <small style="color:#666;" id="wellsCount">–ù–∞–π–¥–µ–Ω–æ: 0</small>
        </div>

        <div class="card">
          <h3>üìã –°–ø–∏—Å–æ–∫ –ø—Ä–æ–±</h3>
          <div class="wells-table">
            <table>
              <thead>
                <tr>
                  <th>Sample</th>
                  <th>–°–∫–≤–∞–∂–∏–Ω–∞</th>
                  <th>–¢–∏–ø / –ë–ª–æ–∫</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
              </thead>
              <tbody id="wellsTableBody">
                <tr>
                  <td colspan="4" style="text-align:center; color:#999; padding:20px;">
                    –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –î–æ–±–∞–≤—å—Ç–µ —Å–∫–≤–∞–∂–∏–Ω—ã –∏–ª–∏ –Ω–∞—á–Ω–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <h3>‚ÑπÔ∏è –°–∏—Å—Ç–µ–º–∞</h3>
          <div style="font-size:12px; display:grid; gap:8px;">
            <div>
              <strong>–°—Ç–∞—Ç—É—Å:</strong>
              <span id="connectionStatus" style="background:#f0f0f0; padding:2px 6px; border-radius:3px;">üî¥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
            </div>
            <div>
              <strong>–í–µ—Ä—Å–∏—è:</strong> 1.0 PWA
            </div>
            <div>
              <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong>
              <input
                type="text"
                id="userNameInput"
                style="width:100%; padding:4px; margin-top:4px; border:1px solid #ddd; border-radius:3px;"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- FOOTER STATS -->
    <div class="footer-stats card">
      <div class="header-stats">
        <div class="header-stat">
          <span>–í—Å–µ–≥–æ</span>
          <strong id="totalWellsHeader">0</strong>
        </div>
        <div class="header-stat">
          <span>–û–ø—Ä–æ–±–æ–≤–∞–Ω–æ</span>
          <strong id="sampledWellsHeader">0</strong>
        </div>
        <div class="header-stat">
          <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
          <strong id="progressHeader">0%</strong>
        </div>
      </div>
      <div class="progress-bar" style="margin-top:10px;">
        <div class="progress-fill" id="progressBar" style="width:0%"></div>
      </div>
      <small style="color:#666;" id="progressText">0 –∏–∑ 0 —Å–∫–≤–∞–∂–∏–Ω</small>
    </div>
  </div>

  <!-- MODAL: –î–æ–±–∞–≤–∏—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã -->
  <div class="modal" id="addWellsModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('addWellsModal')">‚úï</button>
      <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–∫–≤–∞–∂–∏–Ω—ã</h2>
      <p style="font-size:12px; color:#666; margin-bottom:12px;">
        –§–æ—Ä–º–∞—Ç: Sample, X, Y, Z, –°–∫–≤–∞–∂–∏–Ω–∞ (–ø–æ 5 —Å—Ç—Ä–æ–∫ –Ω–∞ –æ–¥–Ω—É –∑–∞–ø–∏—Å—å)
      </p>
      <textarea
        id="wellsTextarea"
        style="width:100%; height:200px; padding:10px; border:1px solid #ddd; border-radius:4px; font-family:monospace; margin-bottom:12px; font-size:12px;"
        placeholder="S001&#10;1234.56&#10;5678.90&#10;100.2&#10;–°–∫–≤–∞–∂–∏–Ω–∞ 1"
      ></textarea>
      <button class="btn btn-primary" onclick="addWellsFromText()" style="width:100%;">‚úì –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>

  <!-- MODAL: –î—É–±–ª–∏–∫–∞—Ç—ã -->
  <div class="modal" id="duplicatesModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('duplicatesModal')">‚úï</button>
      <h2>üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</h2>
      <p style="font-size:12px; color:#666; margin-bottom:12px;">
        –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∞—Ç–Ω–æ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
      </p>
      <select id="duplicateRatio" style="width:100%; padding:10px; margin-bottom:12px; border:1px solid #ddd; border-radius:4px;">
        <option value="1:10">–ö–∞–∂–¥–∞—è 10-—è –ø—Ä–æ–±–∞ (1:10)</option>
        <option value="1:20">–ö–∞–∂–¥–∞—è 20-—è –ø—Ä–æ–±–∞ (1:20)</option>
        <option value="1:5">–ö–∞–∂–¥–∞—è 5-—è –ø—Ä–æ–±–∞ (1:5)</option>
      </select>
      <button class="btn btn-primary" onclick="generateDuplicatesFromModal()" style="width:100%;">‚úì –°–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
      <button class="btn btn-secondary" onclick="exportDuplicates()" style="width:100%; margin-top:8px;">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</button>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <script>
    // PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .catch(err => console.error('SW error:', err));
    }

    // CAMERA & BARCODE
    let codeReader = null;
    let cameraActive = false;
    let lastScannedBarcode = null;

    async function initBarcodeScanner() {
      try {
        const ZXing = window.ZXing;
        codeReader = new ZXing.BrowserMultiFormatReader();
        console.log('Barcode scanner initialized');
        setTimeout(() => startCamera(), 500);
      } catch (e) {
        console.error(e);
        updateCameraStatus('error');
      }
    }

    async function startCamera() {
      try {
        if (!codeReader) await initBarcodeScanner();
        const cameras = await codeReader.listVideoInputDevices();
        if (!cameras.length) {
          showNotification('‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
          updateCameraStatus('error');
          return;
        }
        const selectedDeviceId = cameras[cameras.length - 1].deviceId;
        cameraActive = true;
        updateCameraStatus('scanning');
        await codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
          if (result && cameraActive) {
            const barcode = result.getText();
            if (lastScannedBarcode !== barcode) {
              lastScannedBarcode = barcode;
              handleBarcodeDetected(barcode);
            }
          }
        });
      } catch (e) {
        console.error(e);
        updateCameraStatus('error');
        cameraActive = false;
      }
    }

    function stopCamera() {
      if (codeReader) codeReader.reset();
      cameraActive = false;
      updateCameraStatus('inactive');
    }

    function updateCameraStatus(status) {
      const el = document.getElementById('cameraStatus');
      el.classList.remove('scanning', 'inactive', 'error');
      if (status === 'scanning') {
        el.textContent = 'üü¢ –°–∫–∞–Ω–∏—Ä—É–µ—Ç';
        el.classList.add('scanning');
      } else if (status === 'inactive') {
        el.textContent = '‚≠ï –û—Ç–∫–ª—é—á–µ–Ω–∞';
        el.classList.add('inactive');
      } else if (status === 'error') {
        el.textContent = 'üî¥ –û—à–∏–±–∫–∞';
        el.classList.add('error');
      } else {
        el.textContent = 'üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
      }
    }

    function handleBarcodeDetected(barcode) {
      const input = document.getElementById('barcodeInput');
      if (input.value) return;
      input.value = barcode;
      input.classList.add('filled');
      stopCamera();
      updateScanResult('info', `–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${barcode}`);
      showNotification(`üì∑ –û–±–Ω–∞—Ä—É–∂–µ–Ω: ${barcode}`, 'info');
    }

    // DB
    const db = {
      name: 'well_sampling_db',
      instance: null,

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.name, 1);
          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.instance = request.result;
            resolve(this.instance);
          };
          request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('wells')) {
              const store = db.createObjectStore('wells', { keyPath: 'sample' });
              store.createIndex('status', 'sampling_status', { unique: false });
            }
            if (!db.objectStoreNames.contains('duplicates')) {
              db.createObjectStore('duplicates', { keyPath: 'duplicate_id' });
            }
            if (!db.objectStoreNames.contains('logs')) {
              db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
            }
          };
        });
      },

      async addWells(wellsData) {
        const tx = this.instance.transaction('wells', 'readwrite');
        const store = tx.objectStore('wells');
        return new Promise(resolve => {
          wellsData.forEach(w => store.put(w));
          tx.oncomplete = () => resolve(wellsData.length);
        });
      },

      async addOrUpdateWell(well) {
        const tx = this.instance.transaction('wells', 'readwrite');
        const store = tx.objectStore('wells');
        return new Promise(resolve => {
          store.put(well);
          tx.oncomplete = () => resolve();
        });
      },

      async getAllWells() {
        const tx = this.instance.transaction('wells', 'readonly');
        const store = tx.objectStore('wells');
        return new Promise(resolve => {
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result);
        });
      },

      async addLog(sample, wellName, userName) {
        const tx = this.instance.transaction('logs', 'readwrite');
        const store = tx.objectStore('logs');
        store.add({ sample, wellName, userName, timestamp: Date.now() });
      },

      async addDuplicate(dup) {
        const tx = this.instance.transaction('duplicates', 'readwrite');
        const store = tx.objectStore('duplicates');
        return new Promise(resolve => {
          store.add(dup);
          tx.oncomplete = () => resolve();
        });
      },

      async getAllDuplicates() {
        const tx = this.instance.transaction('duplicates', 'readonly');
        const store = tx.objectStore('duplicates');
        return new Promise(resolve => {
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result);
        });
      },

      async getLogs(limit = 100) {
        const tx = this.instance.transaction('logs', 'readonly');
        const store = tx.objectStore('logs');
        return new Promise(resolve => {
          const req = store.getAll();
          req.onsuccess = () => {
            const logs = req.result.reverse().slice(0, limit);
            resolve(logs);
          };
        });
      },

      async getStatistics() {
        const wells = await this.getAllWells();
        const sampled = wells.filter(w => w.sampling_status === 'sampled').length;
        const completion = wells.length ? (sampled / wells.length) * 100 : 0;
        return {
          totalWells: wells.length,
          sampledWells: sampled,
          completionPercentage: completion.toFixed(1)
        };
      }
    };

    // UI helpers
    let currentUser = localStorage.getItem('userName') || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
    let allWells = [];
    let filteredWells = [];

    function showNotification(msg, type = 'info') {
      const el = document.createElement('div');
      el.className = `notification ${type}`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => {
        el.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => el.remove(), 300);
      }, 2500);
    }

    function showLoading(show = true) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    function showModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function showAddWellsModal() {
      showModal('addWellsModal');
    }

    function showDuplicatesModal() {
      showModal('duplicatesModal');
    }

    function updateScanResult(type, message) {
      const el = document.getElementById('scanResult');
      el.className = `scanner-result ${type}`;
      el.textContent = message;
    }

    async function updateStatistics() {
      try {
        allWells = await db.getAllWells();
        const stats = await db.getStatistics();
        document.getElementById('totalWellsHeader').textContent = stats.totalWells;
        document.getElementById('sampledWellsHeader').textContent = stats.sampledWells;
        document.getElementById('progressHeader').textContent = stats.completionPercentage + '%';
        document.getElementById('progressBar').style.width = stats.completionPercentage + '%';
        document.getElementById('progressText').textContent =
          `${stats.sampledWells} –∏–∑ ${stats.totalWells} —Å–∫–≤–∞–∂–∏–Ω`;

        const today = new Date().toISOString().split('T')[0];
        const logs = await db.getLogs();
        const todayLogs = logs.filter(l =>
          new Date(l.timestamp).toISOString().split('T')[0] === today
        );
        document.getElementById('scannedToday').textContent = todayLogs.length;
        document.getElementById('scannedTotal').textContent = stats.sampledWells;

        renderWells(allWells);
      } catch (e) {
        console.error(e);
      }
    }

    function renderWells(wells) {
      const tbody = document.getElementById('wellsTableBody');
      document.getElementById('wellsCount').textContent = `–ù–∞–π–¥–µ–Ω–æ: ${wells.length}`;
      if (!wells.length) {
        tbody.innerHTML =
          '<tr><td colspan="4" style="text-align:center; color:#999; padding:20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
      }
      tbody.innerHTML = wells.map(w => `
        <tr>
          <td><strong>${w.sample}</strong></td>
          <td style="font-size:10px;">${w.well_name || ''}</td>
          <td style="font-size:10px;">${w.type || ''} / ${w.block || ''}</td>
          <td>
            <span class="status-badge ${w.sampling_status}">
              ${w.sampling_status === 'sampled' ? '‚úì' : '‚óã'}
            </span>
          </td>
        </tr>
      `).join('');
    }

    function filterWells() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('filterStatus').value;
      filteredWells = allWells.filter(w => {
        const mSearch = !search ||
          (w.sample && w.sample.toLowerCase().includes(search)) ||
          (w.well_name && w.well_name.toLowerCase().includes(search));
        const mStatus = status === 'all' || w.sampling_status === status;
        return mSearch && mStatus;
      });
      renderWells(filteredWells);
    }

    async function addWellsFromText() {
      const text = document.getElementById('wellsTextarea').value.trim();
      if (!text) {
        showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ', 'info');
        return;
      }
      showLoading(true);
      try {
        const lines = text.split('\n').filter(l => l.trim());
        const wells = [];
        for (let i = 0; i < lines.length; i += 5) {
          if (i + 4 < lines.length) {
            wells.push({
              sample: lines[i].trim(),
              x_coord: parseFloat(lines[i + 1].trim()) || 0,
              y_coord: parseFloat(lines[i + 2].trim()) || 0,
              z_coord: parseFloat(lines[i + 3].trim()) || 0,
              well_name: lines[i + 4].trim(),
              block: '',
              type: '',
              sampling_status: 'not_sampled',
              created_at: Date.now(),
              sampled_at: null,
              sampled_by: null
            });
          }
        }
        if (!wells.length) throw new Error('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
        const added = await db.addWells(wells);
        showNotification(`‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ ${added} —Å–∫–≤–∞–∂–∏–Ω`, 'success');
        document.getElementById('wellsTextarea').value = '';
        closeModal('addWellsModal');
        await updateStatistics();
      } catch (e) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function processScan() {
      const sample = document.getElementById('barcodeInput').value.trim();
      const wellName = document.getElementById('wellNameInput').value.trim();
      const block = document.getElementById('blockInput').value.trim();
      const type = document.getElementById('typeSelect').value;

      if (!sample) {
        showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ Sample', 'info');
        return;
      }

      showLoading(true);
      try {
        const well = {
          sample,
          well_name: wellName || sample,
          block,
          type,
          sampling_status: 'sampled',
          sampled_at: Date.now(),
          sampled_by: currentUser,
          x_coord: 0,
          y_coord: 0,
          z_coord: 0,
          total_depth: 0,
          created_at: Date.now()
        };

        await db.addOrUpdateWell(well);
        await db.addLog(sample, well.well_name, currentUser);

        updateScanResult('success', `‚úì –ó–∞–ø–∏—Å–∞–Ω–æ\nSample: ${sample}\n–°–∫–≤–∞–∂–∏–Ω–∞: ${well.well_name}`);

        playBeep();
        if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);

        document.getElementById('barcodeInput').value = '';
        document.getElementById('barcodeInput').classList.remove('filled');
        document.getElementById('wellNameInput').value = '';
        lastScannedBarcode = null;

        await updateStatistics();
        await startCamera();
      } catch (e) {
        console.error(e);
        updateScanResult('error', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 800;
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.1);
      } catch (e) {
        console.error(e);
      }
    }

    async function generateDuplicatesFromModal() {
      const ratio = document.getElementById('duplicateRatio').value;
      await generateDuplicates(ratio);
      closeModal('duplicatesModal');
    }

    async function generateDuplicates(ratio = '1:10') {
      showLoading(true);
      try {
        const wells = await db.getAllWells();
        const sampled = wells.filter(w => w.sampling_status === 'sampled');
        if (!sampled.length) {
          showNotification('‚ö†Ô∏è –ù–µ—Ç –æ–ø—Ä–æ–±–æ–≤–∞–Ω–Ω—ã—Ö —Å–∫–≤–∞–∂–∏–Ω', 'info');
          return;
        }
        const [, denom] = ratio.split(':').map(Number);
        let count = 0;
        for (let i = 0; i < sampled.length; i++) {
          if ((i + 1) % denom === 0) {
            await db.addDuplicate({
              duplicate_id: `${sampled[i].sample}_DUP_${Math.floor(i / denom) + 1}`,
              original_sample_id: sampled[i].sample,
              duplicate_ratio: ratio,
              created_at: Date.now(),
              analysis_status: 'not_analyzed'
            });
            count++;
          }
        }
        showNotification(`‚úì –°–æ–∑–¥–∞–Ω–æ ${count} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤`, 'success');
      } catch (e) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function exportToCSV() {
      showLoading(true);
      try {
        const wells = await db.getAllWells();
        if (!wells.length) {
          showNotification('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'info');
          return;
        }
        const headers = ['Sample', '–°–∫–≤–∞–∂–∏–Ω–∞', '–¢–∏–ø', '–ë–ª–æ–∫', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
        const rows = wells.map(w => [
          w.sample,
          w.well_name || '',
          w.type || '',
          w.block || '',
          w.sampling_status === 'sampled' ? '–û–ø—Ä–æ–±–æ–≤–∞–Ω–∞' : '–ù–µ –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∞',
          w.sampled_at ? new Date(w.sampled_at).toLocaleString('ru-RU') : '',
          w.sampled_by || ''
        ]);
        const csv = [headers, ...rows]
          .map(r => r.map(c => `"${c}"`).join(','))
          .join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `–ü–∞—Å–ø–æ—Ä—Ç_–æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è_${new Date().toISOString().split('T')[0]}.csv`);
        link.click();
        showNotification('‚úì –§–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
      } catch (e) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function exportDuplicates() {
      showLoading(true);
      try {
        const duplicates = await db.getAllDuplicates();
        if (!duplicates.length) {
          showNotification('‚ö†Ô∏è –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'info');
          return;
        }
        const headers = ['ID –¥—É–±–ª–∏–∫–∞—Ç–∞', 'Sample', '–ö—Ä–∞—Ç–Ω–æ—Å—Ç—å', '–î–∞—Ç–∞', '–°—Ç–∞—Ç—É—Å'];
        const rows = duplicates.map(d => [
          d.duplicate_id,
          d.original_sample_id,
          d.duplicate_ratio,
          new Date(d.created_at).toLocaleString('ru-RU'),
          d.analysis_status === 'analyzed' ? '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'
        ]);
        const csv = [headers, ...rows]
          .map(r => r.map(c => `"${c}"`).join(','))
          .join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        link.setAttribute('href', url);
        link.setAttribute('download', `–î—É–±–ª–∏–∫–∞—Ç—ã_${new Date().toISOString().split('T')[0]}.csv`);
        link.click();
        showNotification('‚úì –î—É–±–ª–∏–∫–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
      } catch (e) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await db.init();
        await initBarcodeScanner();

        const savedUser = localStorage.getItem('userName');
        if (savedUser) {
          currentUser = savedUser;
          document.getElementById('userNameInput').value = savedUser;
        }
        document.getElementById('userNameInput').addEventListener('change', () => {
          currentUser = document.getElementById('userNameInput').value || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
          localStorage.setItem('userName', currentUser);
        });

        const typeSelect = document.getElementById('typeSelect');
        const savedType = localStorage.getItem('sample_type');
        if (savedType) typeSelect.value = savedType;
        typeSelect.addEventListener('change', () => {
          localStorage.setItem('sample_type', typeSelect.value);
        });

        const blockInput = document.getElementById('blockInput');
        const savedBlock = localStorage.getItem('sample_block');
        if (savedBlock) blockInput.value = savedBlock;
        blockInput.addEventListener('change', () => {
          localStorage.setItem('sample_block', blockInput.value);
        });

        const updateStatus = () => {
          document.getElementById('connectionStatus').textContent =
            navigator.onLine ? '‚úÖ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ–ª–∞–π–Ω';
        };
        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);
        updateStatus();

        await updateStatistics();

        document.getElementById('barcodeInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') processScan();
        });

        console.log('App initialized');
      } catch (e) {
        console.error(e);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error');
      }
    });

    setInterval(updateStatistics, 30000);
  </script>
</body>
</html>
