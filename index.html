<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–± (Sample / –°–∫–≤–∞–∂–∏–Ω–∞ / –¢–∏–ø / –ë–ª–æ–∫)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Sampling">

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <title>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±</title>

  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±</h1>
    </div>

    <div class="main">
      <!-- –í–ï–†–•: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
      <div class="card scanner-panel">
        <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>

        <div class="camera-container">
          <video id="video" playsinline autoplay muted></video>
          <div class="camera-status" id="cameraStatus">üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>

        <div class="input-row">
          <input
            id="sampleInput"
            type="text"
            placeholder="Sample (—à—Ç—Ä–∏—Ö–∫–æ–¥ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)"
            autocomplete="off"
          >
          <button onclick="processScan()">‚úì –ó–∞–ø–∏—Å–∞—Ç—å</button>
        </div>

        <div class="input-row">
          <input
            id="wellNameInput"
            type="text"
            placeholder="–°–∫–≤–∞–∂–∏–Ω–∞ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)"
            autocomplete="off"
          >
        </div>

        <div class="input-row">
          <select id="typeSelect">
            <option value="520">520</option>
            <option value="360">360</option>
          </select>
          <input
            id="blockInput"
            type="text"
            placeholder="–ë–ª–æ–∫ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç–µ)"
            autocomplete="off"
          >
        </div>

        <div class="scanner-result" id="scanResult">
          –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...
        </div>

        <div class="small-stats">
          <div class="small-stat">
            <span>–°–µ–≥–æ–¥–Ω—è</span>
            <strong id="scannedToday">0</strong>
          </div>
          <div class="small-stat">
            <span>–í—Å–µ–≥–æ</span>
            <strong id="scannedTotal">0</strong>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="exportToCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
          <button class="btn btn-secondary" onclick="toggleFooterStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
        </div>
      </div>

      <!-- –ù–ò–ó: —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–± -->
      <div class="card scans-panel">
        <h3>–ó–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –ø—Ä–æ–±—ã</h3>

        <input
          id="searchInput"
          class="search-box"
          type="text"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ Sample –∏–ª–∏ —Å–∫–≤–∞–∂–∏–Ω–µ..."
          oninput="filterScans()"
        >

        <div class="wells-table">
          <table>
            <thead>
              <tr>
                <th>Sample</th>
                <th>–°–∫–≤–∞–∂–∏–Ω–∞</th>
                <th>–¢–∏–ø / –ë–ª–æ–∫</th>
                <th>–î–∞—Ç–∞</th>
              </tr>
            </thead>
            <tbody id="scansTableBody">
              <tr>
                <td colspan="4" style="text-align:center; color:#999; padding:16px;">
                  –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <small id="scansCount" style="margin-top:4px; color:#666;">–ó–∞–ø–∏—Å–µ–π: 0</small>

        <div style="margin-top:6px; font-size:12px;">
          <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong>
          <input
            id="userNameInput"
            type="text"
            style="width:100%; padding:5px; margin-top:4px; border:1px solid #ddd; border-radius:4px;"
            placeholder="–ò–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"
          >
          <div style="margin-top:4px;">
            <strong>–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:</strong>
            <span id="connectionStatus" style="background:#f0f0f0; padding:2px 6px; border-radius:3px;">üî¥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
          </div>
        </div>
      </div>
    </div>

    <!-- –§—É—Ç–µ—Ä-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞, –ø–æ –∫–Ω–æ–ø–∫–µ üìä -->
    <div id="footerStatsWrapper" class="footer-stats hidden">
      <div class="footer-grid">
        <div class="footer-item">
          <span>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</span>
          <strong id="totalScansFooter">0</strong>
        </div>
        <div class="footer-item">
          <span>–°–µ–≥–æ–¥–Ω—è</span>
          <strong id="todayScansFooter">0</strong>
        </div>
        <div class="footer-item">
          <span>–ü–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫</span>
          <strong id="lastBlockFooter">-</strong>
        </div>
      </div>
    </div>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <script>
    const API_URL = '/api/scans/bulk';

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').catch(console.error);
    }

    // ==== CAMERA & BARCODE ====
    let codeReader = null;
    let cameraActive = false;
    let lastScannedBarcode = null;

    async function initBarcodeScanner() {
      try {
        const ZXing = window.ZXing;
        codeReader = new ZXing.BrowserMultiFormatReader();
        setTimeout(() => startCamera(), 400);
      } catch (e) {
        console.error(e);
        updateCameraStatus('error');
      }
    }

    async function startCamera() {
      try {
        if (!codeReader) await initBarcodeScanner();
        const devices = await codeReader.listVideoInputDevices();
        if (!devices.length) {
          showNotification('‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
          updateCameraStatus('error');
          return;
        }
        const deviceId = devices[devices.length - 1].deviceId;
        cameraActive = true;
        updateCameraStatus('scanning');
        await codeReader.decodeFromVideoDevice(deviceId, 'video', (result, err) => {
          if (result && cameraActive) {
            const code = result.getText();
            if (lastScannedBarcode !== code) {
              lastScannedBarcode = code;
              handleBarcodeDetected(code);
            }
          }
        });
      } catch (e) {
        console.error(e);
        cameraActive = false;
        updateCameraStatus('error');
      }
    }

    function stopCamera() {
      if (codeReader) codeReader.reset();
      cameraActive = false;
      updateCameraStatus('inactive');
    }

    function updateCameraStatus(state) {
      const el = document.getElementById('cameraStatus');
      el.classList.remove('scanning','inactive','error');
      if (state === 'scanning') {
        el.textContent = 'üü¢ –°–∫–∞–Ω–∏—Ä—É–µ—Ç';
        el.classList.add('scanning');
      } else if (state === 'inactive') {
        el.textContent = '‚≠ï –û—Ç–∫–ª—é—á–µ–Ω–∞';
        el.classList.add('inactive');
      } else if (state === 'error') {
        el.textContent = 'üî¥ –û—à–∏–±–∫–∞';
        el.classList.add('error');
      } else {
        el.textContent = 'üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
      }
    }

    function handleBarcodeDetected(code) {
      const input = document.getElementById('sampleInput');
      if (input.value) return;
      input.value = code;
      input.classList.add('filled');
      stopCamera();
      updateScanResult('info', `–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${code}`);
      showNotification(`üì∑ –û–±–Ω–∞—Ä—É–∂–µ–Ω: ${code}`, 'info');
    }

    // ==== IndexedDB ====
    const db = {
      name: 'sampling_scans_db_v2',
      instance: null,

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.name, 1);
          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.instance = request.result;
            resolve(this.instance);
          };
          request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('scans')) {
              const store = db.createObjectStore('scans', { keyPath: 'id', autoIncrement: true });
              store.createIndex('sync_status', 'sync_status', { unique: false });
              store.createIndex('scanned_at', 'scanned_at', { unique: false });
            }
          };
        });
      },

      async addScan(scan) {
        const tx = this.instance.transaction('scans', 'readwrite');
        const store = tx.objectStore('scans');
        return new Promise(resolve => {
          store.add(scan);
          tx.oncomplete = () => resolve();
        });
      },

      async getAllScans() {
        const tx = this.instance.transaction('scans', 'readonly');
        const store = tx.objectStore('scans');
        return new Promise(resolve => {
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result || []);
        });
      },

      async getPendingScans() {
        const tx = this.instance.transaction('scans', 'readonly');
        const store = tx.objectStore('scans');
        const idx = store.index('sync_status');
        return new Promise(resolve => {
          const req = idx.getAll('pending');
          req.onsuccess = () => resolve(req.result || []);
        });
      },

      async markSynced(ids) {
        if (!ids.length) return;
        const tx = this.instance.transaction('scans', 'readwrite');
        const store = tx.objectStore('scans');
        await Promise.all(ids.map(id => new Promise(res => {
          const req = store.get(id);
          req.onsuccess = () => {
            const rec = req.result;
            if (rec) {
              rec.sync_status = 'synced';
              store.put(rec);
            }
            res();
          };
        })));
      }
    };

    // ==== UI & –ª–æ–≥–∏–∫–∞ ====
    let currentUser = localStorage.getItem('scan_user') || '–û–ø–µ—Ä–∞—Ç–æ—Ä';
    let allScans = [];

    function showNotification(msg, type='info') {
      const el = document.createElement('div');
      el.className = `notification ${type}`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => {
        el.style.animation = 'slideIn 0.2s ease reverse';
        setTimeout(() => el.remove(), 200);
      }, 2200);
    }

    function showLoading(show=true) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    function updateScanResult(type, msg) {
      const el = document.getElementById('scanResult');
      el.className = `scanner-result ${type}`;
      el.textContent = msg;
    }

    async function refreshScans() {
      allScans = await db.getAllScans();
      renderScans(allScans);
      updateStats(allScans);
    }

    function renderScans(scans) {
      const tbody = document.getElementById('scansTableBody');
      document.getElementById('scansCount').textContent = `–ó–∞–ø–∏—Å–µ–π: ${scans.length}`;
      if (!scans.length) {
        tbody.innerHTML =
          '<tr><td colspan="4" style="text-align:center; color:#999; padding:16px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
        return;
      }
      tbody.innerHTML = scans.slice().reverse().map(s => `
        <tr>
          <td><strong>${s.sample}</strong></td>
          <td style="font-size:11px;">${s.well_name || ''}</td>
          <td style="font-size:11px;">${s.type || ''} / ${s.block || ''}</td>
          <td style="font-size:11px;">${new Date(s.scanned_at).toLocaleString('ru-RU')}</td>
        </tr>
      `).join('');
    }

    function updateStats(scans) {
      const total = scans.length;
      const todayStr = new Date().toISOString().split('T')[0];
      const today = scans.filter(s =>
        new Date(s.scanned_at).toISOString().split('T')[0] === todayStr
      ).length;
      document.getElementById('scannedTotal').textContent = total;
      document.getElementById('scannedToday').textContent = today;
      document.getElementById('totalScansFooter').textContent = total;
      document.getElementById('todayScansFooter').textContent = today;
      const lastBlock = scans.length ? (scans[scans.length - 1].block || '-') : '-';
      document.getElementById('lastBlockFooter').textContent = lastBlock;
    }

    function filterScans() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      const scans = allScans.filter(s =>
        !q ||
        (s.sample && s.sample.toLowerCase().includes(q)) ||
        (s.well_name && s.well_name.toLowerCase().includes(q))
      );
      renderScans(scans);
    }

    function toggleFooterStats() {
      const el = document.getElementById('footerStatsWrapper');
      el.classList.toggle('hidden');
    }

    async function processScan() {
      const sample = document.getElementById('sampleInput').value.trim();
      const wellName = document.getElementById('wellNameInput').value.trim();
      const block = document.getElementById('blockInput').value.trim();
      const type = document.getElementById('typeSelect').value;

      if (!sample) {
        showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ Sample –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ', 'info');
        return;
      }

      showLoading(true);
      try {
        const scan = {
          sample,
          well_name: wellName || '',
          block,
          type,
          scanned_at: Date.now(),
          scanned_by: currentUser,
          sync_status: 'pending'
        };
        await db.addScan(scan);

        updateScanResult('success', `‚úì –ó–∞–ø–∏—Å–∞–Ω–æ\nSample: ${sample}\n–°–∫–≤–∞–∂–∏–Ω–∞: ${scan.well_name}`);
        playBeep();
        if ('vibrate' in navigator) navigator.vibrate([80,40,80]);

        document.getElementById('sampleInput').value = '';
        document.getElementById('sampleInput').classList.remove('filled');
        document.getElementById('wellNameInput').value = '';
        lastScannedBarcode = null;

        await refreshScans();
        await syncPendingScans();
        await startCamera();
      } catch (e) {
        console.error(e);
        updateScanResult('error', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 900;
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.1);
      } catch (e) {
        console.error(e);
      }
    }

    async function exportToCSV() {
      showLoading(true);
      try {
        const scans = await db.getAllScans();
        if (!scans.length) {
          showNotification('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'info');
          return;
        }
        const headers = ['Sample','–°–∫–≤–∞–∂–∏–Ω–∞','–¢–∏–ø','–ë–ª–æ–∫','–î–∞—Ç–∞','–°–æ—Ç—Ä—É–¥–Ω–∏–∫','SyncStatus'];
        const rows = scans.map(s => [
          s.sample,
          s.well_name || '',
          s.type || '',
          s.block || '',
          new Date(s.scanned_at).toLocaleString('ru-RU'),
          s.scanned_by || '',
          s.sync_status || ''
        ]);
        const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `scans_local_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        showNotification('‚úì CSV –≤—ã–≥—Ä—É–∂–µ–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)', 'success');
      } catch (e) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function syncPendingScans() {
      if (!navigator.onLine) return;
      try {
        const pending = await db.getPendingScans();
        if (!pending.length) return;

        const deviceId = localStorage.getItem('device_id') ||
          (function () {
            const id = 'dev-' + Math.random().toString(36).slice(2);
            localStorage.setItem('device_id', id);
            return id;
          })();

        const payload = pending.map(p => ({
          device_id: deviceId,
          sample: p.sample,
          well_name: p.well_name,
          block: p.block,
          type: p.type,
          scanned_at: p.scanned_at,
          scanned_by: p.scanned_by
        }));

        const res = await fetch(API_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);

        await db.markSynced(pending.map(p => p.id));
        await refreshScans();
        showNotification(`‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${pending.length}`, 'success');
      } catch (e) {
        console.error('Sync error', e);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await db.init();
        await initBarcodeScanner();

        const userInput = document.getElementById('userNameInput');
        userInput.value = currentUser;
        userInput.addEventListener('change', () => {
          currentUser = userInput.value || '–û–ø–µ—Ä–∞—Ç–æ—Ä';
          localStorage.setItem('scan_user', currentUser);
        });

        const typeSelect = document.getElementById('typeSelect');
        const savedType = localStorage.getItem('scan_type');
        if (savedType) typeSelect.value = savedType;
        typeSelect.addEventListener('change', () => {
          localStorage.setItem('scan_type', typeSelect.value);
        });

        const blockInput = document.getElementById('blockInput');
        const savedBlock = localStorage.getItem('scan_block');
        if (savedBlock) blockInput.value = savedBlock;
        blockInput.addEventListener('change', () => {
          localStorage.setItem('scan_block', blockInput.value);
        });

        const updateConn = () => {
          document.getElementById('connectionStatus').textContent =
            navigator.onLine ? '‚úÖ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ–ª–∞–π–Ω';
          if (navigator.onLine) syncPendingScans();
        };
        window.addEventListener('online', updateConn);
        window.addEventListener('offline', updateConn);
        updateConn();

        document.getElementById('sampleInput').addEventListener('keypress', e => {
          if (e.key === 'Enter') processScan();
        });

        await refreshScans();
      } catch (e) {
        console.error(e);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error');
      }
    });

    setInterval(refreshScans, 30000);
  </script>
</body>
</html>
