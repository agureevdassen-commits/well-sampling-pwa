<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–± (Sample / –°–∫–≤–∞–∂–∏–Ω–∞ / –¢–∏–ø / –ë–ª–æ–∫)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Sampling">

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <title>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±</title>

  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --primary:#667eea;
      --success:#28a745;
      --danger:#dc3545;
      --info:#17a2b8;
      --light:#f8f9fa;
      --dark:#343a40;
      --bg:#f5f7fa;
      --surface:#ffffff;
      --shadow:0 2px 8px rgba(0,0,0,0.1);
      --shadow-lg:0 8px 24px rgba(0,0,0,0.15);
    }

    html, body {
      height:100%;
      overflow:hidden;
    }

    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:var(--bg);
      color:var(--dark);
      -webkit-user-select:none;
      -webkit-touch-callout:none;
    }

    .container {
      display:flex;
      flex-direction:column;
      height:100vh;
      max-height:100vh;
    }

    .header {
      background:linear-gradient(135deg,var(--primary) 0%,#764ba2 100%);
      color:#fff;
      padding:10px 14px;
      box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    .header h1 { font-size:18px; }

    .main {
      flex:1 1 auto;
      display:grid;
      grid-template-columns:1.1fr 1.1fr;
      gap:10px;
      padding:10px;
      overflow:hidden;
    }

    .card {
      background:var(--surface);
      border-radius:8px;
      padding:10px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .card h2, .card h3 {
      font-size:14px;
      margin-bottom:8px;
      border-bottom:2px solid var(--primary);
      padding-bottom:4px;
      flex:0 0 auto;
    }

    .scanner-panel {
      gap:8px;
    }

    .camera-container {
      width:100%;
      border:2px solid #ddd;
      border-radius:8px;
      overflow:hidden;
      background:#000;
      position:relative;
      flex:0 0 auto;
    }
    #video {
      width:100%;
      height:190px;
      object-fit:cover;
      display:block;
    }
    .camera-status {
      position:absolute;
      top:6px;
      right:6px;
      background:rgba(0,0,0,0.7);
      color:#fff;
      padding:4px 8px;
      font-size:11px;
      border-radius:4px;
      font-weight:600;
    }
    .camera-status.scanning {
      background:rgba(40,167,69,0.95);
      animation:pulse 1.5s infinite;
    }
    .camera-status.inactive { background:rgba(120,120,120,0.9); }
    .camera-status.error { background:rgba(220,53,69,0.95); }

    @keyframes pulse {
      0%,100% { opacity:1; }
      50% { opacity:0.7; }
    }

    .input-row {
      display:flex;
      gap:8px;
      margin-top:6px;
      flex:0 0 auto;
    }

    .input-row input,
    .input-row select {
      flex:1;
      padding:12px;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:15px;
    }

    #sampleInput {
      border-width:2px;
      font-weight:600;
      text-align:center;
      font-size:16px;
      padding:14px;
    }
    #sampleInput:focus {
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 2px rgba(102,126,234,0.15);
      background:#f0f7ff;
    }
    #sampleInput.filled {
      border-color:var(--primary);
      background:#f0f7ff;
    }

    .input-row button {
      padding:12px 16px;
      border:none;
      border-radius:6px;
      background:var(--primary);
      color:#fff;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      flex:0 0 auto;
    }
    .input-row button:active {
      transform:scale(0.96);
      background:#5a67d8;
    }

    .scanner-result {
      background:#f0f0f0;
      border-radius:6px;
      padding:10px;
      min-height:70px;
      font-size:13px;
      color:#666;
      display:flex;
      align-items:center;
      justify-content:center;
      white-space:pre-line;
      margin-top:6px;
      flex:0 0 auto;
    }
    .scanner-result.success {
      background:#d4edda;
      color:#155724;
      border-left:4px solid var(--success);
    }
    .scanner-result.error {
      background:#f8d7da;
      color:#721c24;
      border-left:4px solid var(--danger);
    }

    .small-stats {
      display:flex;
      gap:8px;
      margin-top:6px;
      flex:0 0 auto;
    }
    .small-stat {
      flex:1;
      background:var(--light);
      border-radius:4px;
      padding:6px 8px;
      font-size:12px;
      text-align:center;
    }
    .small-stat strong {
      display:block;
      font-size:16px;
      color:var(--primary);
    }

    .btn-group {
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:6px;
      flex:0 0 auto;
    }
    .btn {
      padding:9px 12px;
      border:none;
      border-radius:6px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-primary:active { background:#5a67d8; }
    .btn-secondary { background:var(--light); color:var(--dark); border:1px solid #ddd; }
    .btn-secondary:active { background:#e9ecef; }

    .search-box {
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:13px;
      margin-bottom:6px;
      flex:0 0 auto;
    }

    .wells-table {
      border:1px solid #ddd;
      border-radius:6px;
      overflow-y:auto;
      flex:1 1 auto;
      min-height:0;
    }
    .wells-table table {
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .wells-table thead {
      background:var(--light);
      position:sticky;
      top:0;
      z-index:1;
    }
    .wells-table th,
    .wells-table td {
      padding:6px;
      border-bottom:1px solid #eee;
      text-align:left;
    }
    .wells-table tr:hover { background:#f8f9fa; }

    .footer-stats {
      margin:6px 10px 10px;
      background:var(--surface);
      border-radius:8px;
      padding:8px 10px;
      box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    .footer-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:6px;
      font-size:11px;
    }
    .footer-item {
      background:#f8f9ff;
      border-radius:4px;
      padding:4px 6px;
      text-align:center;
    }
    .footer-item span { color:#666; }
    .footer-item strong { display:block; font-size:15px; }

    .loading {
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.4);
      z-index:2000;
      align-items:center;
      justify-content:center;
    }
    .loading.active { display:flex; }
    .spinner {
      width:40px; height:40px;
      border-radius:50%;
      border:4px solid rgba(255,255,255,0.3);
      border-top-color:#fff;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    .notification {
      position:fixed;
      bottom:16px;
      right:16px;
      padding:10px 14px;
      border-radius:6px;
      color:#fff;
      font-size:12px;
      z-index:2100;
      animation:slideIn 0.25s ease;
    }
    .notification.success { background:var(--success); }
    .notification.error { background:var(--danger); }
    .notification.info { background:var(--info); }
    @keyframes slideIn {
      from { transform:translateX(100%); opacity:0; }
      to { transform:translateX(0); opacity:1; }
    }

    @media (max-width:900px) {
      .main {
        grid-template-columns:1fr;
        grid-auto-rows:minmax(0,1fr);
      }
      #video { height:170px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±</h1>
    </div>

    <div class="main">
      <!-- –õ–ï–í–û: —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
      <div class="card scanner-panel">
        <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>

        <div class="camera-container">
          <video id="video" playsinline autoplay muted></video>
          <div class="camera-status" id="cameraStatus">üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>

        <div class="input-row">
          <input
            id="sampleInput"
            type="text"
            placeholder="Sample (—à—Ç—Ä–∏—Ö–∫–æ–¥ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)"
            autocomplete="off"
          >
          <button onclick="processScan()">‚úì –ó–∞–ø–∏—Å–∞—Ç—å</button>
        </div>

        <div class="input-row">
          <input
            id="wellNameInput"
            type="text"
            placeholder="–°–∫–≤–∞–∂–∏–Ω–∞ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)"
            autocomplete="off"
          >
        </div>

        <div class="input-row">
          <select id="typeSelect">
            <option value="520">520</option>
            <option value="360">360</option>
          </select>
          <input
            id="blockInput"
            type="text"
            placeholder="–ë–ª–æ–∫ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç–µ)"
            autocomplete="off"
          >
        </div>

        <div class="scanner-result" id="scanResult">
          –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...
        </div>

        <div class="small-stats">
          <div class="small-stat">
            <span>–°–µ–≥–æ–¥–Ω—è</span>
            <strong id="scannedToday">0</strong>
          </div>
          <div class="small-stat">
            <span>–í—Å–µ–≥–æ</span>
            <strong id="scannedTotal">0</strong>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="exportToCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
        </div>
      </div>

      <!-- –ü–†–ê–í–û: —Å–ø–∏—Å–æ–∫ -->
      <div class="card">
        <h3>–ó–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –ø—Ä–æ–±—ã</h3>

        <input
          id="searchInput"
          class="search-box"
          type="text"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ Sample –∏–ª–∏ —Å–∫–≤–∞–∂–∏–Ω–µ..."
          oninput="filterScans()"
        >

        <div class="wells-table">
          <table>
            <thead>
              <tr>
                <th>Sample</th>
                <th>–°–∫–≤–∞–∂–∏–Ω–∞</th>
                <th>–¢–∏–ø / –ë–ª–æ–∫</th>
                <th>–î–∞—Ç–∞</th>
              </tr>
            </thead>
            <tbody id="scansTableBody">
              <tr>
                <td colspan="4" style="text-align:center; color:#999; padding:16px;">
                  –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <small id="scansCount" style="margin-top:4px; color:#666;">–ó–∞–ø–∏—Å–µ–π: 0</small>

        <div style="margin-top:6px; font-size:12px;">
          <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong>
          <input
            id="userNameInput"
            type="text"
            style="width:100%; padding:5px; margin-top:4px; border:1px solid #ddd; border-radius:4px;"
            placeholder="–ò–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"
          >
          <div style="margin-top:4px;">
            <strong>–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:</strong>
            <span id="connectionStatus" style="background:#f0f0f0; padding:2px 6px; border-radius:3px;">üî¥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
          </div>
        </div>
      </div>
    </div>

  
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <script>
    // ===== Service Worker (offline-first) =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').catch(console.error);
    }

    // ===== CAMERA & BARCODE =====
    let codeReader = null;
    let cameraActive = false;
    let lastScannedBarcode = null;

    async function initBarcodeScanner() {
      try {
        const ZXing = window.ZXing;
        codeReader = new ZXing.BrowserMultiFormatReader();
        console.log('Barcode scanner initialized');
        setTimeout(() => startCamera(), 400);
      } catch (e) {
        console.error(e);
        updateCameraStatus('error');
      }
    }

    async function startCamera() {
      try {
        if (!codeReader) await initBarcodeScanner();
        const devices = await codeReader.listVideoInputDevices();
        if (!devices.length) {
          showNotification('‚ùå –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
          updateCameraStatus('error');
          return;
        }
        const deviceId = devices[devices.length - 1].deviceId;
        cameraActive = true;
        updateCameraStatus('scanning');
        await codeReader.decodeFromVideoDevice(deviceId, 'video', (result, err) => {
          if (result && cameraActive) {
            const code = result.getText();
            if (lastScannedBarcode !== code) {
              lastScannedBarcode = code;
              handleBarcodeDetected(code);
            }
          }
        });
      } catch (e) {
        console.error(e);
        cameraActive = false;
        updateCameraStatus('error');
      }
    }

    function stopCamera() {
      if (codeReader) codeReader.reset();
      cameraActive = false;
      updateCameraStatus('inactive');
    }

    function updateCameraStatus(state) {
      const el = document.getElementById('cameraStatus');
      el.classList.remove('scanning','inactive','error');
      if (state === 'scanning') {
        el.textContent = 'üü¢ –°–∫–∞–Ω–∏—Ä—É–µ—Ç';
        el.classList.add('scanning');
      } else if (state === 'inactive') {
        el.textContent = '‚≠ï –û—Ç–∫–ª—é—á–µ–Ω–∞';
        el.classList.add('inactive');
      } else if (state === 'error') {
        el.textContent = 'üî¥ –û—à–∏–±–∫–∞';
        el.classList.add('error');
      } else {
        el.textContent = 'üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
      }
    }

    function handleBarcodeDetected(code) {
      const input = document.getElementById('sampleInput');
      if (input.value) return;
      input.value = code;
      input.classList.add('filled');
      stopCamera();
      updateScanResult('info', `–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${code}`);
      showNotification(`üì∑ –û–±–Ω–∞—Ä—É–∂–µ–Ω: ${code}`, 'info');
    }

    // ===== IndexedDB (–ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ) =====
    const db = {
      name: 'sampling_scans_db_v2',
      instance: null,

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.name, 1);
          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.instance = request.result;
            resolve(this.instance);
          };
          request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('scans')) {
              const store = db.createObjectStore('scans', { keyPath: 'id', autoIncrement: true });
              store.createIndex('sync_status', 'sync_status', { unique: false });
              store.createIndex('scanned_at', 'scanned_at', { unique: false });
            }
          };
        });
      },

      async addScan(scan) {
        const tx = this.instance.transaction('scans', 'readwrite');
        const store = tx.objectStore('scans');
        return new Promise(resolve => {
          store.add(scan);
          tx.oncomplete = () => resolve();
        });
      },

      async getAllScans() {
        const tx = this.instance.transaction('scans', 'readonly');
        const store = tx.objectStore('scans');
        return new Promise(resolve => {
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result || []);
        });
      },

      async getPendingScans() {
        const tx = this.instance.transaction('scans', 'readonly');
        const store = tx.objectStore('scans');
        const idx = store.index('sync_status');
        return new Promise(resolve => {
          const req = idx.getAll('pending');
          req.onsuccess = () => resolve(req.result || []);
        });
      },

      async markSynced(ids) {
        if (!ids.length) return;
        const tx = this.instance.transaction('scans', 'readwrite');
        const store = tx.objectStore('scans');
        await Promise.all(ids.map(id => new Promise(res => {
          const req = store.get(id);
          req.onsuccess = () => {
            const rec = req.result;
            if (rec) {
              rec.sync_status = 'synced';
              store.put(rec);
            }
            res();
          };
        })));
      }
    };

    // ===== UI & –ª–æ–≥–∏–∫–∞ =====
    let currentUser = localStorage.getItem('scan_user') || '–û–ø–µ—Ä–∞—Ç–æ—Ä';
    let allScans = [];
    let filteredScans = [];

    function showNotification(msg, type='info') {
      const el = document.createElement('div');
      el.className = `notification ${type}`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => {
        el.style.animation = 'slideIn 0.2s ease reverse';
        setTimeout(() => el.remove(), 200);
      }, 2200);
    }

    function showLoading(show=true) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    function updateScanResult(type, msg) {
      const el = document.getElementById('scanResult');
      el.className = `scanner-result ${type}`;
      el.textContent = msg;
    }

    async function refreshScans() {
      allScans = await db.getAllScans();
      renderScans(allScans);
      updateStats(allScans);
    }

    function renderScans(scans) {
      const tbody = document.getElementById('scansTableBody');
      document.getElementById('scansCount').textContent = `–ó–∞–ø–∏—Å–µ–π: ${scans.length}`;
      if (!scans.length) {
        tbody.innerHTML =
          '<tr><td colspan="4" style="text-align:center; color:#999; padding:16px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
        return;
      }
      tbody.innerHTML = scans.slice().reverse().map(s => `
        <tr>
          <td><strong>${s.sample}</strong></td>
          <td style="font-size:11px;">${s.well_name || ''}</td>
          <td style="font-size:11px;">${s.type || ''} / ${s.block || ''}</td>
          <td style="font-size:11px;">${new Date(s.scanned_at).toLocaleString('ru-RU')}</td>
        </tr>
      `).join('');
    }

    function updateStats(scans) {
      const total = scans.length;
      const todayStr = new Date().toISOString().split('T')[0];
      const today = scans.filter(s =>
        new Date(s.scanned_at).toISOString().split('T')[0] === todayStr
      ).length;
      document.getElementById('scannedTotal').textContent = total;
      document.getElementById('scannedToday').textContent = today;
      document.getElementById('totalScansFooter').textContent = total;
      document.getElementById('todayScansFooter').textContent = today;
      const lastBlock = scans.length ? (scans[scans.length - 1].block || '-') : '-';
      document.getElementById('lastBlockFooter').textContent = lastBlock;
    }

    function filterScans() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      const scans = allScans.filter(s =>
        !q ||
        (s.sample && s.sample.toLowerCase().includes(q)) ||
        (s.well_name && s.well_name.toLowerCase().includes(q))
      );
      renderScans(scans);
    }

    async function processScan() {
      const sample = document.getElementById('sampleInput').value.trim();
      const wellName = document.getElementById('wellNameInput').value.trim();
      const block = document.getElementById('blockInput').value.trim();
      const type = document.getElementById('typeSelect').value;

      if (!sample) {
        showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ Sample –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ', 'info');
        return;
      }

      showLoading(true);
      try {
        const scan = {
          sample,
          well_name: wellName || '',
          block,
          type,
          scanned_at: Date.now(),
          scanned_by: currentUser,
          sync_status: 'pending'
        };
        await db.addScan(scan);

        updateScanResult('success', `‚úì –ó–∞–ø–∏—Å–∞–Ω–æ\nSample: ${sample}\n–°–∫–≤–∞–∂–∏–Ω–∞: ${scan.well_name}`);
        playBeep();
        if ('vibrate' in navigator) navigator.vibrate([80,40,80]);

        document.getElementById('sampleInput').value = '';
        document.getElementById('sampleInput').classList.remove('filled');
        document.getElementById('wellNameInput').value = '';
        lastScannedBarcode = null;

        await refreshScans();
        await syncPendingScans();
        await startCamera();
      } catch (e) {
        console.error(e);
        updateScanResult('error', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 900;
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.1);
      } catch (e) {
        console.error(e);
      }
    }

    // ===== –õ–æ–∫–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç CSV (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞) =====
    async function exportToCSV() {
      showLoading(true);
      try {
        const scans = await db.getAllScans();
        if (!scans.length) {
          showNotification('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'info');
          return;
        }
        const headers = ['Sample','–°–∫–≤–∞–∂–∏–Ω–∞','–¢–∏–ø','–ë–ª–æ–∫','–î–∞—Ç–∞','–°–æ—Ç—Ä—É–¥–Ω–∏–∫','SyncStatus'];
        const rows = scans.map(s => [
          s.sample,
          s.well_name || '',
          s.type || '',
          s.block || '',
          new Date(s.scanned_at).toLocaleString('ru-RU'),
          s.scanned_by || '',
          s.sync_status || ''
        ]);
        const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `scans_local_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        showNotification('‚úì CSV –≤—ã–≥—Ä—É–∂–µ–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)', 'success');
      } catch (e) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    // ===== –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å —Å–∞–π—Ç–æ–º (–ø–æ–¥ API) =====
    async function syncPendingScans() {
      if (!navigator.onLine) return;
      try {
        const pending = await db.getPendingScans();
        if (!pending.length) return;

        const res = await fetch('/api/scans/bulk', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(pending)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);

        const syncedIds = pending.map(s => s.id);
        await db.markSynced(syncedIds);
        await refreshScans();
        showNotification(`‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${pending.length}`, 'success');
      } catch (e) {
        console.error('Sync error', e);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await db.init();
        await initBarcodeScanner();

        const userInput = document.getElementById('userNameInput');
        userInput.value = currentUser;
        userInput.addEventListener('change', () => {
          currentUser = userInput.value || '–û–ø–µ—Ä–∞—Ç–æ—Ä';
          localStorage.setItem('scan_user', currentUser);
        });

        const typeSelect = document.getElementById('typeSelect');
        const savedType = localStorage.getItem('scan_type');
        if (savedType) typeSelect.value = savedType;
        typeSelect.addEventListener('change', () => {
          localStorage.setItem('scan_type', typeSelect.value);
        });

        const blockInput = document.getElementById('blockInput');
        const savedBlock = localStorage.getItem('scan_block');
        if (savedBlock) blockInput.value = savedBlock;
        blockInput.addEventListener('change', () => {
          localStorage.setItem('scan_block', blockInput.value);
        });

        const updateConn = () => {
          document.getElementById('connectionStatus').textContent =
            navigator.onLine ? '‚úÖ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ–ª–∞–π–Ω';
          if (navigator.onLine) syncPendingScans();
        };
        window.addEventListener('online', updateConn);
        window.addEventListener('offline', updateConn);
        updateConn();

        document.getElementById('sampleInput').addEventListener('keypress', e => {
          if (e.key === 'Enter') processScan();
        });

        await refreshScans();
      } catch (e) {
        console.error(e);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error');
      }
    });

    setInterval(refreshScans, 30000);
  </script>
</body>
</html>

