<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Å–ø–æ—Ä—Ç–æ–º –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="–û–ø—Ä–æ–±–æ–≤–∞–Ω–∏–µ">
  
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  
  <title>–ü–∞—Å–ø–æ—Ä—Ç –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary: #667eea;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --light: #f8f9fa;
      --dark: #343a40;
      --bg: #f5f7fa;
      --surface: #ffffff;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--dark);
      line-height: 1.5;
      height: 100vh;
      overflow: hidden;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ===== HEADER ===== */
    .header {
      background: linear-gradient(135deg, var(--primary) 0%, #764ba2 100%);
      color: white;
      padding: 16px 20px;
      box-shadow: var(--shadow);
      z-index: 100;
    }

    .header h1 {
      font-size: 20px;
      margin: 0 0 8px 0;
    }

    .header-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      font-size: 12px;
    }

    .header-stat {
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 10px;
      border-radius: 4px;
      text-align: center;
    }

    .header-stat strong {
      display: block;
      font-size: 16px;
      margin-top: 4px;
    }

    /* ===== MAIN CONTENT ===== */
    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      padding: 16px;
      overflow-y: auto;
    }

    /* ===== –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï ===== */
    .scanner-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      background: var(--surface);
      border-radius: 8px;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .scanner-panel h2 {
      font-size: 16px;
      margin: 0 0 12px 0;
      border-bottom: 2px solid var(--primary);
      padding-bottom: 8px;
    }

    .scanner-input {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .scanner-input input {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
    }

    .scanner-input input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .scanner-input button {
      padding: 12px 20px;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .scanner-input button:active {
      transform: scale(0.95);
      background: #5a67d8;
    }

    .scanner-result {
      background: #f0f0f0;
      padding: 12px;
      border-radius: 6px;
      font-size: 13px;
      min-height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #999;
    }

    .scanner-result.success {
      background: #d4edda;
      color: #155724;
      border-left: 4px solid var(--success);
    }

    .scanner-result.error {
      background: #f8d7da;
      color: #721c24;
      border-left: 4px solid var(--danger);
    }

    .scanner-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }

    .scanner-stat {
      background: var(--light);
      padding: 8px 12px;
      border-radius: 4px;
      text-align: center;
      font-size: 12px;
    }

    .scanner-stat strong {
      display: block;
      font-size: 18px;
      color: var(--primary);
      margin-top: 4px;
    }

    /* ===== –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –ö–û–ù–¢–†–û–õ–¨ ===== */
    .control-panel {
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
    }

    .card {
      background: var(--surface);
      border-radius: 8px;
      padding: 16px;
      box-shadow: var(--shadow);
    }

    .card h3 {
      font-size: 14px;
      margin: 0 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--primary);
    }

    /* ===== –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–ê ===== */
    .file-upload {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .file-upload input {
      padding: 8px;
      border: 2px dashed #ddd;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
    }

    .file-upload input:hover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.05);
    }

    /* ===== –ö–ù–û–ü–ö–ò ===== */
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:active {
      background: #5a67d8;
      transform: scale(0.98);
    }

    .btn-secondary {
      background: var(--light);
      color: var(--dark);
      border: 1px solid #ddd;
    }

    .btn-secondary:active {
      background: #e9ecef;
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-danger {
      background: var(--danger);
      color: white;
    }

    .btn-small {
      padding: 6px 10px;
      font-size: 12px;
    }

    /* ===== –¢–ê–ë–õ–ò–¶–ê –°–ö–í–ê–ñ–ò–ù ===== */
    .wells-table {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
    }

    .wells-table table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .wells-table thead {
      background: var(--light);
      position: sticky;
      top: 0;
    }

    .wells-table th {
      padding: 6px;
      text-align: left;
      font-weight: 600;
      border-bottom: 1px solid #ddd;
    }

    .wells-table td {
      padding: 6px;
      border-bottom: 1px solid #ddd;
    }

    .wells-table tr:hover {
      background: rgba(102, 126, 234, 0.05);
    }

    .status-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 10px;
      font-weight: 600;
    }

    .status-badge.sampled {
      background: #d4edda;
      color: #155724;
    }

    .status-badge.not-sampled {
      background: #fff3cd;
      color: #856404;
    }

    /* ===== –ü–û–ò–°–ö –ò –§–ò–õ–¨–¢–†–´ ===== */
    .search-box {
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      width: 100%;
      margin-bottom: 8px;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.1);
    }

    .filter-select {
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
      width: 100%;
      margin-bottom: 8px;
    }

    /* ===== –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê ===== */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 20px;
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .modal-content h2 {
      margin: 0 0 16px 0;
    }

    .modal-close {
      position: absolute;
      top: 12px;
      right: 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ===== –ü–†–û–ì–†–ï–°–° –ë–ê–† ===== */
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #e9ecef;
      border-radius: 10px;
      overflow: hidden;
      margin: 8px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), #764ba2);
      width: 0%;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 11px;
      font-weight: 600;
    }

    /* ===== –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===== */
    .notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 6px;
      color: white;
      font-size: 13px;
      animation: slideIn 0.3s ease;
      z-index: 999;
    }

    .notification.success {
      background: var(--success);
    }

    .notification.error {
      background: var(--danger);
    }

    .notification.info {
      background: var(--info);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ===== –†–ï–°–ü–û–ù–°–ò–í ===== */
    @media (max-width: 1024px) {
      .main {
        grid-template-columns: 1fr;
        padding: 12px;
      }

      .header-stats {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 768px) {
      .header h1 {
        font-size: 16px;
      }

      .header-stats {
        grid-template-columns: repeat(2, 1fr);
        font-size: 11px;
      }

      .card {
        padding: 12px;
      }

      .card h3 {
        font-size: 13px;
      }

      .scanner-result {
        min-height: 60px;
        font-size: 12px;
      }
    }

    /* ===== LOADING ===== */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }

    .loading.active {
      display: flex;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== –°–ö–†–´–¢–ò–ï –õ–ò–®–ù–ò–• –≠–õ–ï–ú–ï–ù–¢–û–í ===== */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <h1>üìä –ü–∞—Å–ø–æ—Ä—Ç –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω</h1>
      <div class="header-stats">
        <div class="header-stat">
          <span>–í—Å–µ–≥–æ</span>
          <strong id="totalWellsHeader">0</strong>
        </div>
        <div class="header-stat">
          <span>–û–ø—Ä–æ–±–æ–≤–∞–Ω–æ</span>
          <strong id="sampledWellsHeader">0</strong>
        </div>
        <div class="header-stat">
          <span>–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
          <strong id="progressHeader">0%</strong>
        </div>
      </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
      <!-- –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨: –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï -->
      <div class="scanner-panel">
        <h2>üîç –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤</h2>

        <!-- –í–≤–æ–¥ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞ -->
        <div class="scanner-input">
          <input 
            type="text" 
            id="barcodeInput" 
            placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ ID —Å–∫–≤–∞–∂–∏–Ω—ã"
            autocomplete="off"
          >
          <button onclick="processScan()">‚úì –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
        <div class="scanner-result" id="scanResult">
          –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        </div>

        <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
        <div style="margin-top: 12px;">
          <small style="color: #666;">–°—Ç–∞—Ç—É—Å –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è</small>
          <div class="progress-bar">
            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
          </div>
          <small style="color: #666;" id="progressText">0 –∏–∑ 0 —Å–∫–≤–∞–∂–∏–Ω</small>
        </div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="scanner-stats">
          <div class="scanner-stat">
            <span>–°–µ–≥–æ–¥–Ω—è</span>
            <strong id="scannedToday">0</strong>
          </div>
          <div class="scanner-stat">
            <span>–í—Å–µ–≥–æ</span>
            <strong id="scannedTotal">0</strong>
          </div>
        </div>

        <!-- –î–µ–π—Å—Ç–≤–∏—è -->
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showUploadModal()">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å DVG —Ñ–∞–π–ª</button>
          <button class="btn btn-secondary" onclick="showDuplicatesModal()">üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
          <button class="btn btn-secondary" onclick="exportToExcel()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
        </div>
      </div>

      <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –°–ü–ò–°–û–ö –ü–†–û–ë -->
      <div class="control-panel">
        <!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
        <div class="card">
          <h3>üîé –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
          <input 
            type="text" 
            class="search-box" 
            id="searchInput" 
            placeholder="–ü–æ–∏—Å–∫ –ø–æ ID –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é..."
            onkeyup="filterWells()"
          >
          <select class="filter-select" id="filterStatus" onchange="filterWells()">
            <option value="all">üìå –í—Å–µ —Å–∫–≤–∞–∂–∏–Ω—ã</option>
            <option value="sampled">‚úì –û–ø—Ä–æ–±–æ–≤–∞–Ω—ã</option>
            <option value="not_sampled">‚óã –ù–µ –æ–ø—Ä–æ–±–æ–≤–∞–Ω—ã</option>
          </select>
          <small style="color: #666;" id="wellsCount">–ù–∞–π–¥–µ–Ω–æ: 0</small>
        </div>

        <!-- –°–ø–∏—Å–æ–∫ —Å–∫–≤–∞–∂–∏–Ω -->
        <div class="card">
          <h3>üìã –°–ø–∏—Å–æ–∫ –ø—Ä–æ–±</h3>
          <div class="wells-table">
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                  <th>–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</th>
                  <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
              </thead>
              <tbody id="wellsTableBody">
                <tr>
                  <td colspan="4" style="text-align: center; color: #999; padding: 20px;">
                    –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ó–∞–≥—Ä—É–∑–∏—Ç–µ DVG —Ñ–∞–π–ª
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
        <div class="card">
          <h3>‚ÑπÔ∏è –°–∏—Å—Ç–µ–º–∞</h3>
          <div style="font-size: 12px; display: grid; gap: 8px;">
            <div>
              <strong>–°—Ç–∞—Ç—É—Å:</strong>
              <span id="connectionStatus" style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">üî¥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
            </div>
            <div>
              <strong>–í–µ—Ä—Å–∏—è:</strong> 1.0 PWA
            </div>
            <div>
              <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong>
              <input 
                type="text" 
                id="userNameInput" 
                style="width: 100%; padding: 4px; margin-top: 4px; border: 1px solid #ddd; border-radius: 3px;"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è"
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ -->
  <div class="modal" id="uploadModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('uploadModal')">‚úï</button>
      <h2>üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–µ—Å—Ç—Ä —Å–∫–≤–∞–∂–∏–Ω (DVG)</h2>
      <p style="font-size: 12px; color: #666; margin-bottom: 12px;">
        –í—ã–±–µ—Ä–∏—Ç–µ Excel —Ñ–∞–π–ª —Å –∫–æ–ª–æ–Ω–∫–∞–º–∏: ID, X, Y, Z, –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
      </p>
      <input type="file" id="dvgFile" accept=".xlsx,.xls,.csv" style="width: 100%; margin-bottom: 12px;">
      <button class="btn btn-primary" onclick="uploadDVGFile()" style="width: 100%;">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
    </div>
  </div>

  <!-- MODAL: –î—É–±–ª–∏–∫–∞—Ç—ã -->
  <div class="modal" id="duplicatesModal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeModal('duplicatesModal')">‚úï</button>
      <h2>üîÑ –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –ø—Ä–æ–±</h2>
      <p style="font-size: 12px; color: #666; margin-bottom: 12px;">
        –í—ã–±–µ—Ä–∏—Ç–µ –∫—Ä–∞—Ç–Ω–æ—Å—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
      </p>
      <select style="width: 100%; padding: 10px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 4px;">
        <option value="1:10">–ö–∞–∂–¥–∞—è 10-—è –ø—Ä–æ–±–∞ (1:10)</option>
        <option value="1:20">–ö–∞–∂–¥–∞—è 20-—è –ø—Ä–æ–±–∞ (1:20)</option>
        <option value="1:5">–ö–∞–∂–¥–∞—è 5-—è –ø—Ä–æ–±–∞ (1:5)</option>
      </select>
      <button class="btn btn-primary" onclick="generateDuplicatesFromModal()" style="width: 100%;">‚úì –°–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
      <button class="btn btn-secondary" onclick="exportDuplicates()" style="width: 100%; margin-top: 8px;">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</button>
    </div>
  </div>

  <!-- LOADING -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <!-- Service Worker Registration & Scripts -->
  <script>
    // ========== PWA SETUP ==========
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js')
        .then(reg => console.log('‚úì Service Worker registered'))
        .catch(err => console.error('‚úó Service Worker error:', err));
    }

    // ========== DATABASE INITIALIZATION ==========
    const db = {
      name: 'well_sampling_db',
      instance: null,

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.name, 1);
          
          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.instance = request.result;
            console.log('‚úì Database initialized');
            resolve(this.instance);
          };
          
          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            
            if (!db.objectStoreNames.contains('wells')) {
              const wellStore = db.createObjectStore('wells', { keyPath: 'well_id' });
              wellStore.createIndex('status', 'sampling_status', { unique: false });
            }
            
            if (!db.objectStoreNames.contains('duplicates')) {
              db.createObjectStore('duplicates', { keyPath: 'duplicate_id' });
            }
            
            if (!db.objectStoreNames.contains('logs')) {
              db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
            }
          };
        });
      },

      async addWells(wellsData) {
        const tx = this.instance.transaction('wells', 'readwrite');
        const store = tx.objectStore('wells');
        
        return new Promise((resolve) => {
          wellsData.forEach(well => {
            store.add({
              ...well,
              sampling_status: 'not_sampled',
              created_at: Date.now(),
              sampled_at: null,
              sampled_by: null
            });
          });
          
          tx.oncomplete = () => resolve(wellsData.length);
        });
      },

      async getAllWells() {
        const tx = this.instance.transaction('wells', 'readonly');
        const store = tx.objectStore('wells');
        
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
        });
      },

      async updateWellStatus(wellId, userName) {
        const tx = this.instance.transaction('wells', 'readwrite');
        const store = tx.objectStore('wells');
        
        return new Promise((resolve, reject) => {
          const request = store.get(wellId);
          request.onsuccess = () => {
            const well = request.result;
            if (!well) {
              reject(new Error('Well not found'));
              return;
            }
            
            well.sampling_status = 'sampled';
            well.sampled_at = Date.now();
            well.sampled_by = userName;
            store.put(well);
            resolve(well);
          };
        });
      },

      async addLog(wellId, wellName, userName) {
        const tx = this.instance.transaction('logs', 'readwrite');
        const store = tx.objectStore('logs');
        
        store.add({
          wellId,
          wellName,
          userName,
          timestamp: Date.now()
        });
      },

      async addDuplicate(duplicate) {
        const tx = this.instance.transaction('duplicates', 'readwrite');
        const store = tx.objectStore('duplicates');
        
        return new Promise((resolve) => {
          store.add(duplicate);
          tx.oncomplete = () => resolve();
        });
      },

      async getAllDuplicates() {
        const tx = this.instance.transaction('duplicates', 'readonly');
        const store = tx.objectStore('duplicates');
        
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => resolve(request.result);
        });
      },

      async getLogs(limit = 100) {
        const tx = this.instance.transaction('logs', 'readonly');
        const store = tx.objectStore('logs');
        
        return new Promise((resolve) => {
          const request = store.getAll();
          request.onsuccess = () => {
            const logs = request.result.reverse().slice(0, limit);
            resolve(logs);
          };
        });
      },

      async getStatistics() {
        const wells = await this.getAllWells();
        const sampled = wells.filter(w => w.sampling_status === 'sampled').length;
        const completion = wells.length > 0 ? (sampled / wells.length) * 100 : 0;
        
        return {
          totalWells: wells.length,
          sampledWells: sampled,
          completionPercentage: completion.toFixed(1)
        };
      },

      async clearAllData() {
        const tx = this.instance.transaction(['wells', 'duplicates', 'logs'], 'readwrite');
        tx.objectStore('wells').clear();
        tx.objectStore('duplicates').clear();
        tx.objectStore('logs').clear();
      }
    };

    // ========== UI HELPERS ==========
    let currentUser = localStorage.getItem('userName') || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
    let filteredWells = [];
    let allWells = [];

    function showNotification(message, type = 'info') {
      const notif = document.createElement('div');
      notif.className = `notification ${type}`;
      notif.textContent = message;
      document.body.appendChild(notif);
      
      setTimeout(() => {
        notif.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => notif.remove(), 300);
      }, 2500);
    }

    function showLoading(show = true) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    function showModal(id) {
      document.getElementById(id).classList.add('active');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('active');
    }

    function showUploadModal() {
      showModal('uploadModal');
    }

    function showDuplicatesModal() {
      showModal('duplicatesModal');
    }

    // ========== –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========
    async function updateStatistics() {
      try {
        allWells = await db.getAllWells();
        const stats = await db.getStatistics();
        
        document.getElementById('totalWellsHeader').textContent = stats.totalWells;
        document.getElementById('sampledWellsHeader').textContent = stats.sampledWells;
        document.getElementById('progressHeader').textContent = stats.completionPercentage + '%';
        
        document.getElementById('progressBar').style.width = stats.completionPercentage + '%';
        document.getElementById('progressText').textContent = `${stats.sampledWells} –∏–∑ ${stats.totalWells} —Å–∫–≤–∞–∂–∏–Ω`;
        
        // –°–µ–≥–æ–¥–Ω—è—à–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        const today = new Date().toISOString().split('T');
        const logs = await db.getLogs();
        const todayLogs = logs.filter(l => 
          new Date(l.timestamp).toISOString().split('T') === today
        );
        
        document.getElementById('scannedToday').textContent = todayLogs.length;
        document.getElementById('scannedTotal').textContent = stats.sampledWells;
        
        renderWells(allWells);
      } catch (error) {
        console.error('Error updating statistics:', error);
      }
    }

    // ========== –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï –°–ö–í–ê–ñ–ò–ù ==========
    function renderWells(wells) {
      const tbody = document.getElementById('wellsTableBody');
      document.getElementById('wellsCount').textContent = `–ù–∞–π–¥–µ–Ω–æ: ${wells.length}`;
      
      if (wells.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: #999; padding: 20px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        return;
      }
      
      tbody.innerHTML = wells.map(well => `
        <tr>
          <td><strong>${well.well_id}</strong></td>
          <td style="font-size: 10px;">${well.well_name}</td>
          <td style="font-size: 9px;">X: ${well.x_coord.toFixed(1)}</td>
          <td>
            <span class="status-badge ${well.sampling_status}">
              ${well.sampling_status === 'sampled' ? '‚úì' : '‚óã'}
            </span>
          </td>
        </tr>
      `).join('');
    }

    function filterWells() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('filterStatus').value;
      
      filteredWells = allWells.filter(well => {
        const matchesSearch = !search || 
          well.well_id.toLowerCase().includes(search) ||
          well.well_name.toLowerCase().includes(search);
        
        const matchesStatus = status === 'all' || well.sampling_status === status;
        
        return matchesSearch && matchesStatus;
      });
      
      renderWells(filteredWells);
    }

    // ========== –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï ==========
    async function processScan() {
      const barcode = document.getElementById('barcodeInput').value.trim();
      
      if (!barcode) {
        showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥', 'info');
        return;
      }

      showLoading(true);
      
      try {
        const well = allWells.find(w => w.well_id === barcode);
        
        if (!well) {
          document.getElementById('scanResult').innerHTML = '‚ùå –°–∫–≤–∞–∂–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞';
          document.getElementById('scanResult').className = 'scanner-result error';
          showNotification('‚ùå –°–∫–≤–∞–∂–∏–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
          document.getElementById('barcodeInput').value = '';
          return;
        }

        await db.updateWellStatus(well.well_id, currentUser);
        await db.addLog(well.well_id, well.well_name, currentUser);
        
        document.getElementById('scanResult').innerHTML = `
          <div>
            <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong><br>
            ${well.well_name}<br>
            ID: ${well.well_id}
          </div>
        `;
        document.getElementById('scanResult').className = 'scanner-result success';
        
        playBeep();
        if ('vibrate' in navigator) navigator.vibrate([100, 50, 100]);
        
        showNotification(`‚úì ${well.well_name} –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∞`, 'success');
        
        document.getElementById('barcodeInput').value = '';
        document.getElementById('barcodeInput').focus();
        
        await updateStatistics();
      } catch (error) {
        console.error('Scan error:', error);
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    function playBeep() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      
      osc.connect(gain);
      gain.connect(audioContext.destination);
      
      osc.frequency.value = 800;
      gain.gain.setValueAtTime(0.3, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      osc.start(audioContext.currentTime);
      osc.stop(audioContext.currentTime + 0.1);
    }

    // ========== –ó–ê–ì–†–£–ó–ö–ê DVG ==========
    async function uploadDVGFile() {
      const file = document.getElementById('dvgFile').files;
      if (!file) {
        showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'info');
        return;
      }

      showLoading(true);
      
      try {
        const reader = new FileReader();
        reader.onload = async (e) => {
          try {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä CSV –∏–ª–∏ –ø—Ä–æ—Å—Ç—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
            const text = e.target.result;
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            
            const wells = [];
            for (let i = 1; i < lines.length; i++) {
              const parts = lines[i].split('\t').map(p => p.trim());
              if (parts.length >= 5) {
                wells.push({
                  well_id: parts,
                  x_coord: parseFloat(parts),
                  y_coord: parseFloat(parts),
                  z_coord: parseFloat(parts),
                  well_name: parts || `–°–∫–≤–∞–∂–∏–Ω–∞ ${parts}`,
                  total_depth: parseFloat(parts) || 0
                });
              }
            }
            
            if (wells.length === 0) {
              throw new Error('–ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª–µ');
            }
            
            const added = await db.addWells(wells);
            showNotification(`‚úì –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${added} —Å–∫–≤–∞–∂–∏–Ω`, 'success');
            closeModal('uploadModal');
            await updateStatistics();
          } catch (error) {
            showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
          } finally {
            showLoading(false);
          }
        };
        
        reader.readAsText(file);
      } catch (error) {
        console.error('Upload error:', error);
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
        showLoading(false);
      }
    }

    // ========== –î–£–ë–õ–ò–ö–ê–¢–´ ==========
    async function generateDuplicatesFromModal() {
      const ratio = document.querySelector('#duplicatesModal select').value;
      await generateDuplicates(ratio);
      closeModal('duplicatesModal');
    }

    async function generateDuplicates(ratio = '1:10') {
      showLoading(true);
      
      try {
        const wells = await db.getAllWells();
        const sampledWells = wells.filter(w => w.sampling_status === 'sampled');
        
        if (sampledWells.length === 0) {
          showNotification('‚ö†Ô∏è –ù–µ—Ç –æ–ø—Ä–æ–±–æ–≤–∞–Ω–Ω—ã—Ö —Å–∫–≤–∞–∂–∏–Ω', 'info');
          return;
        }

        const [num, denom] = ratio.split(':').map(Number);
        let count = 0;
        
        for (let i = 0; i < sampledWells.length; i++) {
          if ((i + 1) % denom === 0) {
            await db.addDuplicate({
              duplicate_id: `${sampledWells[i].well_id}_DUP_${Math.floor(i / denom) + 1}`,
              original_sample_id: sampledWells[i].well_id,
              duplicate_ratio: ratio,
              created_at: Date.now(),
              analysis_status: 'not_analyzed'
            });
            count++;
          }
        }
        
        showNotification(`‚úì –°–æ–∑–¥–∞–Ω–æ ${count} –¥—É–±–ª–∏–∫–∞—Ç–æ–≤`, 'success');
      } catch (error) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    // ========== –≠–ö–°–ü–û–†–¢ ==========
    async function exportToExcel() {
      showLoading(true);
      
      try {
        const wells = await db.getAllWells();
        
        if (wells.length === 0) {
          showNotification('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'info');
          return;
        }
        
        // –°–æ–∑–¥–∞–µ–º CSV
        const headers = ['ID', '–ù–∞–∑–≤–∞–Ω–∏–µ', 'X', 'Y', 'Z', '–ì–ª—É–±–∏–Ω–∞', '–°—Ç–∞—Ç—É—Å', '–î–∞—Ç–∞', '–°–æ—Ç—Ä—É–¥–Ω–∏–∫'];
        const rows = wells.map(w => [
          w.well_id,
          w.well_name,
          w.x_coord.toFixed(2),
          w.y_coord.toFixed(2),
          w.z_coord.toFixed(2),
          w.total_depth,
          w.sampling_status === 'sampled' ? '–û–ø—Ä–æ–±–æ–≤–∞–Ω–∞' : '–ù–µ –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∞',
          w.sampled_at ? new Date(w.sampled_at).toLocaleString('ru-RU') : '',
          w.sampled_by || ''
        ]);
        
        const csv = [headers, ...rows]
          .map(row => row.map(cell => `"${cell}"`).join(','))
          .join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `–ü–∞—Å–ø–æ—Ä—Ç_–æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è_${new Date().toISOString().split('T')}.csv`);
        link.click();
        
        showNotification('‚úì –§–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
      } catch (error) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function exportDuplicates() {
      showLoading(true);
      
      try {
        const duplicates = await db.getAllDuplicates();
        
        if (duplicates.length === 0) {
          showNotification('‚ö†Ô∏è –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'info');
          return;
        }
        
        const headers = ['ID –¥—É–±–ª–∏–∫–∞—Ç–∞', '–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–∞', '–ö—Ä–∞—Ç–Ω–æ—Å—Ç—å', '–î–∞—Ç–∞', '–°—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞'];
        const rows = duplicates.map(d => [
          d.duplicate_id,
          d.original_sample_id,
          d.duplicate_ratio,
          new Date(d.created_at).toLocaleString('ru-RU'),
          d.analysis_status === 'analyzed' ? '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'
        ]);
        
        const csv = [headers, ...rows]
          .map(row => row.map(cell => `"${cell}"`).join(','))
          .join('\n');
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `–î—É–±–ª–∏–∫–∞—Ç—ã_${new Date().toISOString().split('T')}.csv`);
        link.click();
        
        showNotification('‚úì –î—É–±–ª–∏–∫–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
      } catch (error) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await db.init();
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const saved = localStorage.getItem('userName');
        if (saved) {
          currentUser = saved;
          document.getElementById('userNameInput').value = saved;
        }
        
        document.getElementById('userNameInput').addEventListener('change', () => {
          currentUser = document.getElementById('userNameInput').value || '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
          localStorage.setItem('userName', currentUser);
        });
        
        // –°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        const updateStatus = () => {
          const status = navigator.onLine ? '‚úÖ –û–Ω–ª–∞–π–Ω' : 'üî¥ –û—Ñ–ª–∞–π–Ω';
          document.getElementById('connectionStatus').textContent = status;
        };
        
        window.addEventListener('online', updateStatus);
        window.addEventListener('offline', updateStatus);
        updateStatus();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        await updateStatistics();
        
        // –§–æ–∫—É—Å –Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
        document.getElementById('barcodeInput').focus();
        
        // Enter –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        document.getElementById('barcodeInput').addEventListener('keypress', (e) => {
          if (e.key === 'Enter') processScan();
        });
        
        console.log('‚úì App initialized');
      } catch (error) {
        console.error('Init error:', error);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error');
      }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
    setInterval(updateStatistics, 30000);
  </script>
</body>
</html>
