<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#667eea">
  <meta name="description" content="–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–± (Sample / –°–∫–≤–∞–∂–∏–Ω–∞ / –¢–∏–ø / –ë–ª–æ–∫)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Sampling">

  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/png" href="/icons/icon-192.png">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">

  <title>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±</title>

  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --primary:#667eea;
      --success:#28a745;
      --danger:#dc3545;
      --info:#17a2b8;
      --light:#f8f9fa;
      --dark:#343a40;
      --bg:#f5f7fa;
      --surface:#ffffff;
      --shadow:0 2px 8px rgba(0,0,0,0.1);
      --shadow-lg:0 8px 24px rgba(0,0,0,0.15);
    }

    html, body { height:100%; overflow:hidden; }

    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:var(--bg);
      color:var(--dark);
      -webkit-user-select:none;
      -webkit-touch-callout:none;
    }

    .container {
      display:flex;
      flex-direction:column;
      height:100vh;
      max-height:100vh;
    }

    .header {
      background:linear-gradient(135deg,var(--primary) 0%,#764ba2 100%);
      color:#fff;
      padding:8px 12px;
      box-shadow:var(--shadow);
      flex:0 0 auto;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .header h1 { font-size:18px; }

    .header-right {
      font-size:11px;
      background:rgba(255,255,255,0.12);
      padding:3px 8px;
      border-radius:4px;
    }
    .sync-indicator { font-size:11px; }
    .sync-indicator.pending { color:#ffc107; }
    .sync-indicator.ok { color:#c3f3c3; }

    .main {
      flex:1 1 auto;
      display:grid;
      grid-template-columns:1.1fr 1.1fr;
      gap:10px;
      padding:10px;
      overflow:hidden;
      padding-bottom:60px;
    }

    .card {
      background:var(--surface);
      border-radius:8px;
      padding:10px;
      box-shadow:var(--shadow);
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .card h2, .card h3 {
      font-size:14px;
      margin-bottom:8px;
      border-bottom:2px solid var(--primary);
      padding-bottom:4px;
      flex:0 0 auto;
    }

    .scanner-panel { gap:8px; }

    .camera-container {
      width:100%;
      border:2px solid #ddd;
      border-radius:8px;
      overflow:hidden;
      background:#000;
      position:relative;
      flex:0 0 auto;
    }
    #video {
      width:100%;
      height:190px;
      object-fit:cover;
      display:block;
    }
    .camera-status {
      position:absolute;
      top:6px;
      right:6px;
      background:rgba(0,0,0,0.7);
      color:#fff;
      padding:4px 8px;
      font-size:11px;
      border-radius:4px;
      font-weight:600;
    }
    .camera-status.scanning { background:rgba(40,167,69,0.95); animation:pulse 1.5s infinite; }
    .camera-status.inactive { background:rgba(120,120,120,0.9); }
    .camera-status.error { background:rgba(220,53,69,0.95); }

    @keyframes pulse { 0%,100%{opacity:1;} 50%{opacity:0.7;} }

    .input-row {
      display:flex;
      gap:8px;
      margin-top:6px;
      flex:0 0 auto;
      min-height:48px;
    }

    .input-row input,
    .input-row select {
      flex:1;
      padding:12px;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:15px;
    }

    #sampleInput {
      border-width:2px;
      font-weight:600;
      text-align:center;
      font-size:16px;
      padding:14px;
    }
    #sampleInput:focus {
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 2px rgba(102,126,234,0.15);
      background:#f0f7ff;
    }
    #sampleInput.filled {
      border-color:var(--primary);
      background:#f0f7ff;
    }

    .input-row button {
      min-width:48px;
      min-height:48px;
      padding:12px 16px;
      border:none;
      border-radius:6px;
      background:var(--primary);
      color:#fff;
      font-size:15px;
      font-weight:600;
      cursor:pointer;
      flex:0 0 auto;
    }
    .input-row button:active { transform:scale(0.96); background:#5a67d8; }

    .scanner-result {
      background:#f0f0f0;
      border-radius:6px;
      padding:10px;
      min-height:70px;
      font-size:13px;
      color:#666;
      display:flex;
      align-items:center;
      justify-content:center;
      white-space:pre-line;
      margin-top:6px;
      flex:0 0 auto;
    }
    .scanner-result.success {
      background:#d4edda;
      color:#155724;
      border-left:4px solid var(--success);
    }
    .scanner-result.error {
      background:#f8d7da;
      color:#721c24;
      border-left:4px solid var(--danger);
    }

    .small-stats {
      display:flex;
      gap:8px;
      margin-top:6px;
      flex:0 0 auto;
    }
    .small-stat {
      flex:1;
      background:var(--light);
      border-radius:4px;
      padding:6px 8px;
      font-size:12px;
      text-align:center;
    }
    .small-stat strong {
      display:block;
      font-size:16px;
      color:var(--primary);
    }

    .btn-group {
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:6px;
      flex:0 0 auto;
    }
    .btn {
      min-height:48px;
      padding:10px 12px;
      border:none;
      border-radius:6px;
      font-size:13px;
      font-weight:600;
      cursor:pointer;
    }
    .btn-primary { background:var(--primary); color:#fff; }
    .btn-primary:active { background:#5a67d8; }

    .search-box {
      padding:8px 10px;
      border:1px solid #ddd;
      border-radius:6px;
      font-size:13px;
      margin-bottom:6px;
      flex:0 0 auto;
    }

    .filter-row {
      display:flex;
      gap:6px;
      align-items:center;
      font-size:11px;
      margin-bottom:4px;
    }
    .filter-row label {
      display:flex;
      align-items:center;
      gap:4px;
    }

    .wells-table {
      border:1px solid #ddd;
      border-radius:6px;
      overflow-y:auto;
      flex:1 1 auto;
      min-height:0;
    }
    .wells-table table {
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    .wells-table thead {
      background:var(--light);
      position:sticky;
      top:0;
      z-index:1;
    }
    .wells-table th,
    .wells-table td {
      padding:6px;
      border-bottom:1px solid #eee;
      text-align:left;
    }

    .footer-stats {
      margin:4px 10px 68px;
      background:var(--surface);
      border-radius:8px;
      padding:8px 10px;
      box-shadow:var(--shadow);
      flex:0 0 auto;
    }
    .footer-grid {
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:6px;
      font-size:11px;
    }
    .footer-item {
      background:#f8f9ff;
      border-radius:4px;
      padding:4px 6px;
      text-align:center;
    }

    .toolbar {
      position:fixed;
      bottom:0;
      left:0;
      right:0;
      height:56px;
      background:var(--surface);
      box-shadow:0 -2px 6px rgba(0,0,0,0.15);
      display:flex;
      justify-content:space-around;
      align-items:center;
      z-index:1500;
      padding-bottom:env(safe-area-inset-bottom);
    }
    .toolbar-btn {
      flex:1;
      margin:0 4px;
      min-height:40px;
      border:none;
      border-radius:20px;
      background:var(--primary);
      color:#fff;
      font-size:13px;
      font-weight:600;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      cursor:pointer;
    }
    .toolbar-btn:active { background:#5a67d8; transform:scale(0.97); }

    .loading {
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.4);
      z-index:2000;
      align-items:center;
      justify-content:center;
    }
    .loading.active { display:flex; }
    .spinner {
      width:40px; height:40px;
      border-radius:50%;
      border:4px solid rgba(255,255,255,0.3);
      border-top-color:#fff;
      animation:spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform:rotate(360deg); } }

    .notification {
      position:fixed;
      bottom:70px;
      right:16px;
      padding:10px 14px;
      border-radius:6px;
      color:#fff;
      font-size:12px;
      z-index:2100;
      animation:slideIn 0.25s ease;
    }
    .notification.success { background:var(--success); }
    .notification.error { background:var(--danger); }
    .notification.info { background:var(--info); }
    @keyframes slideIn { from{transform:translateX(100%);opacity:0;} to{transform:translateX(0);opacity:1;} }

    .hidden { display:none !important; }

    .modal {
      display:none;
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      background:rgba(0,0,0,0.5);
      z-index:3000;
      align-items:center;
      justify-content:center;
    }
    .modal.active { display:flex; }
    .modal-content {
      background:#fff;
      max-width:90%;
      max-height:80vh;
      border-radius:8px;
      box-shadow:var(--shadow-lg);
      padding:12px;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .modal-close {
      position:absolute;
      top:8px;
      right:8px;
      width:28px;
      height:28px;
      border-radius:50%;
      border:none;
      background:#eee;
      cursor:pointer;
      font-size:18px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .log-area {
      flex:1 1 auto;
      min-height:0;
      overflow:auto;
      border:1px solid #ddd;
      border-radius:4px;
      padding:6px;
      font-size:11px;
      background:#fafafa;
      white-space:pre-wrap;
    }

    @media (max-width:900px) {
      .main { grid-template-columns:1fr; grid-auto-rows:minmax(0,1fr); }
      #video { height:170px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±</h1>
      <div class="header-right">
        <div id="syncIndicator" class="sync-indicator">
          ‚áÖ –ª–æ–∫–∞–ª—å–Ω–æ 0, –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ 0
        </div>
      </div>
    </div>

    <div class="main">
      <div class="card scanner-panel">
        <h2>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>

        <div class="camera-container">
          <video id="video" playsinline autoplay muted></video>
          <div class="camera-status" id="cameraStatus">üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
        </div>

        <div class="input-row">
          <input id="sampleInput" type="text" placeholder="Sample (—à—Ç—Ä–∏—Ö–∫–æ–¥ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é)" autocomplete="off">
          <button onclick="processScan()">‚úì –ó–∞–ø–∏—Å–∞—Ç—å</button>
        </div>

        <div class="input-row">
          <input
            id="wellNameInput"
            type="text"
            placeholder="–°–∫–≤–∞–∂–∏–Ω–∞ (—Ä—É—á–Ω–æ–π –≤–≤–æ–¥)"
            autocomplete="off"
            inputmode="numeric"
            pattern="[0-9]*"
          >
        </div>

        <div class="input-row">
          <select id="typeSelect">
            <option value="520">520</option>
            <option value="360">360</option>
          </select>
          <input
            id="blockInput"
            type="text"
            placeholder="–ë–ª–æ–∫ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –ø–æ–∫–∞ –Ω–µ –∏–∑–º–µ–Ω–∏—Ç–µ)"
            autocomplete="off"
          >
        </div>

        <div class="scanner-result" id="scanResult">
          –û–∂–∏–¥–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...
        </div>

        <div class="small-stats">
          <div class="small-stat">
            <span>–°–µ–≥–æ–¥–Ω—è</span>
            <strong id="scannedToday">0</strong>
          </div>
          <div class="small-stat">
            <span>–í—Å–µ–≥–æ</span>
            <strong id="scannedTotal">0</strong>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="exportToCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç CSV (–ª–æ–∫–∞–ª—å–Ω–æ)</button>
        </div>
      </div>

      <div id="samplesPanel" class="card hidden">
        <h3>–ó–∞–ø–∏—Å–∞–Ω–Ω—ã–µ –ø—Ä–æ–±—ã</h3>

        <input
          id="searchInput"
          class="search-box"
          type="text"
          placeholder="–ü–æ–∏—Å–∫ –ø–æ Sample –∏–ª–∏ —Å–∫–≤–∞–∂–∏–Ω–µ..."
          oninput="filterScans()"
        >

        <div class="filter-row">
          <label>
            <input type="checkbox" id="pendingOnlyCheckbox" onchange="filterScans()">
            —Ç–æ–ª—å–∫–æ –Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ
          </label>
        </div>

        <div class="wells-table">
          <table>
            <thead>
              <tr>
                <th>Sample</th>
                <th>–°–∫–≤–∞–∂–∏–Ω–∞</th>
                <th>–¢–∏–ø / –ë–ª–æ–∫</th>
                <th>–î–∞—Ç–∞</th>
              </tr>
            </thead>
            <tbody id="scansTableBody">
              <tr>
                <td colspan="4" style="text-align:center; color:#999; padding:16px;">
                  –ù–µ—Ç –∑–∞–ø–∏—Å–µ–π
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <small id="scansCount" style="margin-top:4px; color:#666;">–ó–∞–ø–∏—Å–µ–π: 0</small>

        <div style="margin-top:6px; font-size:12px;">
          <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</strong>
          <input
            id="userNameInput"
            type="text"
            style="width:100%; padding:5px; margin-top:4px; border:1px solid #ddd; border-radius:4px;"
            placeholder="–ò–º—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"
          >
          <div style="margin-top:4px;">
            <strong>–°—Ç–∞—Ç—É—Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:</strong>
            <span id="connectionStatus" style="background:#f0f0f0; padding:2px 6px; border-radius:3px;">üî¥ –ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
          </div>
        </div>
      </div>
    </div>

    <div id="footerStatsWrapper" class="footer-stats hidden">
      <div class="footer-grid">
        <div class="footer-item">
          <span>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π</span>
          <strong id="totalScansFooter">0</strong>
        </div>
        <div class="footer-item">
          <span>–°–µ–≥–æ–¥–Ω—è</span>
          <strong id="todayScansFooter">0</strong>
        </div>
        <div class="footer-item">
          <span>–ü–æ—Å–ª–µ–¥–Ω–∏–π –±–ª–æ–∫</span>
          <strong id="lastBlockFooter">-</strong>
        </div>
      </div>
      <div style="margin-top:6px; font-size:11px; color:#666;">
        –í–µ—Ä—Å–∏—è: 1.0.0 PWA ‚Ä¢ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ + SQL —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
      </div>
    </div>
  </div>

  <div class="toolbar">
    <button class="toolbar-btn" onclick="toggleSamplesPanel()">üìã –ü—Ä–æ–±—ã</button>
    <button class="toolbar-btn" onclick="toggleFooterStats()">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    <button class="toolbar-btn" onclick="openDiagnostics()">‚öô –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
  </div>

  <div class="loading" id="loading">
    <div class="spinner"></div>
  </div>

  <div id="diagnosticsModal" class="modal">
    <div class="modal-content">
      <button class="modal-close" onclick="closeDiagnostics()">‚úï</button>
      <h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h3>
      <div class="log-area" id="diagnosticsLog">
        –ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç.
      </div>
      <button class="btn" style="margin-top:6px; background:var(--light); border:1px solid #ddd;" onclick="clearDiagnosticsLog()">–û—á–∏—Å—Ç–∏—Ç—å –∂—É—Ä–Ω–∞–ª</button>
    </div>
  </div>

  <script>
    const API_URL = '/api/scans/bulk';

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/service-worker.js').catch(console.error);
    }

    let codeReader = null;
    let cameraActive = false;
    let lastScannedBarcode = null;
    let currentUser = localStorage.getItem('scan_user') || '–û–ø–µ—Ä–∞—Ç–æ—Ä';
    let allScans = [];
    let lastServerCount = null;

    async function initBarcodeScanner() {
      try {
        const ZXing = window.ZXing;
        codeReader = new ZXing.BrowserMultiFormatReader();
        setTimeout(() => startCamera(), 400);
      } catch (e) {
        console.error(e);
        updateCameraStatus('error');
      }
    }

    async function startCamera() {
      try {
        if (!codeReader) await initBarcodeScanner();
        cameraActive = true;
        updateCameraStatus('scanning');
        await codeReader.decodeFromVideoDevice(undefined, 'video', (result, err) => {
          if (result && cameraActive) {
            const code = result.getText();
            if (lastScannedBarcode !== code) {
              lastScannedBarcode = code;
              handleBarcodeDetected(code);
            }
          }
        });
      } catch (e) {
        console.error(e);
        cameraActive = false;
        updateCameraStatus('error');
      }
    }

    function stopCamera() {
      if (codeReader) codeReader.reset();
      cameraActive = false;
      updateCameraStatus('inactive');
    }

    function updateCameraStatus(state) {
      const el = document.getElementById('cameraStatus');
      el.classList.remove('scanning','inactive','error');
      if (state === 'scanning') {
        el.textContent = 'üü¢ –°–∫–∞–Ω–∏—Ä—É–µ—Ç';
        el.classList.add('scanning');
      } else if (state === 'inactive') {
        el.textContent = '‚≠ï –û—Ç–∫–ª—é—á–µ–Ω–∞';
        el.classList.add('inactive');
      } else if (state === 'error') {
        el.textContent = 'üî¥ –û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã';
        el.classList.add('error');
      } else {
        el.textContent = 'üìπ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...';
      }
    }

    function handleBarcodeDetected(code) {
      const input = document.getElementById('sampleInput');
      if (input.value) return;
      input.value = code;
      input.classList.add('filled');
      stopCamera();
      updateScanResult('info', `–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ: ${code}`);
      showNotification(`üì∑ –û–±–Ω–∞—Ä—É–∂–µ–Ω: ${code}`, 'info');
    }

    const db = {
      name: 'sampling_scans_db_v2',
      instance: null,

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.name, 1);
          request.onerror = () => reject(request.error);
          request.onsuccess = () => { this.instance = request.result; resolve(this.instance); };
          request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('scans')) {
              const store = db.createObjectStore('scans', { keyPath: 'id', autoIncrement: true });
              store.createIndex('sync_status', 'sync_status', { unique: false });
              store.createIndex('scanned_at', 'scanned_at', { unique: false });
            }
            if (!db.objectStoreNames.contains('logs')) {
              db.createObjectStore('logs', { keyPath: 'id', autoIncrement: true });
            }
          };
        });
      },

      async addScan(scan) {
        const tx = this.instance.transaction('scans', 'readwrite');
        const store = tx.objectStore('scans');
        return new Promise(resolve => { store.add(scan); tx.oncomplete = () => resolve(); });
      },

      async getAllScans() {
        const tx = this.instance.transaction('scans', 'readonly');
        const store = tx.objectStore('scans');
        return new Promise(resolve => {
          const req = store.getAll();
          req.onsuccess = () => resolve(req.result || []);
        });
      },

      async getPendingScans() {
        const tx = this.instance.transaction('scans', 'readonly');
        const store = tx.objectStore('scans');
        const idx = store.index('sync_status');
        return new Promise(resolve => {
          const req = idx.getAll('pending');
          req.onsuccess = () => resolve(req.result || []);
        });
      },

      async markSynced(ids, serverIds = []) {
        if (!ids.length) return;
        const tx = this.instance.transaction('scans', 'readwrite');
        const store = tx.objectStore('scans');
        await Promise.all(ids.map((id, i) => new Promise(res => {
          const req = store.get(id);
          req.onsuccess = () => {
            const rec = req.result;
            if (rec) {
              rec.sync_status = 'synced';
              if (serverIds[i]) rec.server_id = serverIds[i];
              store.put(rec);
            }
            res();
          };
        })));
      },

      async addLog(entry) {
        const tx = this.instance.transaction('logs', 'readwrite');
        const store = tx.objectStore('logs');
        store.add({ ...entry, ts: Date.now() });
      },

      async getLogs(limit = 100) {
        const tx = this.instance.transaction('logs', 'readonly');
        const store = tx.objectStore('logs');
        return new Promise(resolve => {
          const req = store.getAll();
          req.onsuccess = () => {
            const all = req.result || [];
            resolve(all.slice(-limit));
          };
        });
      },

      async clearLogs() {
        const tx = this.instance.transaction('logs', 'readwrite');
        const store = tx.objectStore('logs');
        return new Promise(resolve => {
          const req = store.clear();
          req.onsuccess = () => resolve();
        });
      }
    };

    function showNotification(msg, type='info') {
      const el = document.createElement('div');
      el.className = `notification ${type}`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => {
        el.style.animation = 'slideIn 0.2s ease reverse';
        setTimeout(() => el.remove(), 200);
      }, 2200);
    }

    function showLoading(show=true) {
      document.getElementById('loading').classList.toggle('active', show);
    }

    function updateScanResult(type, msg) {
      const el = document.getElementById('scanResult');
      el.className = `scanner-result ${type}`;
      el.textContent = msg;
    }

    async function refreshScans() {
      allScans = await db.getAllScans();
      renderScans(allScans);
      updateStats(allScans);
      updateSyncIndicator();
    }

    function renderScans(scans) {
      const tbody = document.getElementById('scansTableBody');
      document.getElementById('scansCount').textContent = `–ó–∞–ø–∏—Å–µ–π: ${scans.length}`;
      if (!scans.length) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#999; padding:16px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</td></tr>';
        return;
      }
      tbody.innerHTML = scans.slice().reverse().map(s => `
        <tr>
          <td><strong>${s.sample}</strong>${s.server_id ? `<br><span style="font-size:9px;color:#999;">#${s.server_id}</span>` : ''}</td>
          <td style="font-size:11px;">${s.well_name || ''}</td>
          <td style="font-size:11px;">${s.type || ''} / ${s.block || ''}</td>
          <td style="font-size:11px;">${new Date(s.scanned_at).toLocaleString('ru-RU')}</td>
        </tr>
      `).join('');
    }

    function updateStats(scans) {
      const total = scans.length;
      const todayStr = new Date().toISOString().split('T')[0];
      const today = scans.filter(s =>
        new Date(s.scanned_at).toISOString().split('T')[0] === todayStr
      ).length;
      document.getElementById('scannedTotal').textContent = total;
      document.getElementById('scannedToday').textContent = today;
      document.getElementById('totalScansFooter').textContent = total;
      document.getElementById('todayScansFooter').textContent = today;
      const lastBlock = scans.length ? (scans[scans.length - 1].block || '-') : '-';
      document.getElementById('lastBlockFooter').textContent = lastBlock;
    }

    function filterScans() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      const pendingOnly = document.getElementById('pendingOnlyCheckbox').checked;
      let scans = allScans;
      if (pendingOnly) scans = scans.filter(s => s.sync_status === 'pending');
      scans = scans.filter(s =>
        !q ||
        (s.sample && s.sample.toLowerCase().includes(q)) ||
        (s.well_name && s.well_name.toLowerCase().includes(q))
      );
      renderScans(scans);
    }

    function toggleFooterStats() {
      document.getElementById('footerStatsWrapper').classList.toggle('hidden');
    }
    function toggleSamplesPanel() {
      document.getElementById('samplesPanel').classList.toggle('hidden');
    }

    async function processScan() {
      const sample   = document.getElementById('sampleInput').value.trim();
      const wellName = document.getElementById('wellNameInput').value.trim();
      const block    = document.getElementById('blockInput').value.trim();
      const type     = document.getElementById('typeSelect').value;

      if (!sample) {
        showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ Sample –∏–ª–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ', 'info');
        return;
      }
      if (!wellName) {
        showNotification('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–°–∫–≤–∞–∂–∏–Ω–∞"', 'info');
        document.getElementById('wellNameInput').focus();
        return;
      }
      if (!block) {
        showNotification('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ "–ë–ª–æ–∫"', 'info');
        document.getElementById('blockInput').focus();
        return;
      }

      showLoading(true);
      try {
        const scan = {
          sample,
          well_name: wellName,
          block,
          type,
          scanned_at: Date.now(),
          scanned_by: currentUser,
          sync_status: 'pending'
        };
        await db.addScan(scan);

        updateScanResult('success', `‚úì –ó–∞–ø–∏—Å–∞–Ω–æ\nSample: ${sample}\n–°–∫–≤–∞–∂–∏–Ω–∞: ${scan.well_name}\n–ë–ª–æ–∫: ${scan.block}`);
        playBeep();
        if ('vibrate' in navigator) navigator.vibrate([80,40,80]);

        document.getElementById('sampleInput').value = '';
        document.getElementById('sampleInput').classList.remove('filled');
        lastScannedBarcode = null;

        await refreshScans();
        await syncPendingScans();

        document.getElementById('sampleInput').focus();
        await startCamera();
      } catch (e) {
        console.error(e);
        await db.addLog({ level:'error', message:`processScan: ${e.message}` });
        updateScanResult('error', `‚ùå –û—à–∏–±–∫–∞: ${e.message}`);
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.connect(gain);
        gain.connect(ctx.destination);
        osc.frequency.value = 900;
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.1);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.1);
      } catch (e) { console.error(e); }
    }

    async function exportToCSV() {
      showLoading(true);
      try {
        const scans = await db.getAllScans();
        if (!scans.length) {
          showNotification('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'info');
          return;
        }
        const headers = ['Sample','–°–∫–≤–∞–∂–∏–Ω–∞','–¢–∏–ø','–ë–ª–æ–∫','–î–∞—Ç–∞','–°–æ—Ç—Ä—É–¥–Ω–∏–∫','SyncStatus','ServerID'];
        const rows = scans.map(s => [
          s.sample,
          s.well_name || '',
          s.type || '',
          s.block || '',
          new Date(s.scanned_at).toLocaleString('ru-RU'),
          s.scanned_by || '',
          s.sync_status || '',
          s.server_id || ''
        ]);
        const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `scans_local_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        showNotification('‚úì CSV –≤—ã–≥—Ä—É–∂–µ–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)', 'success');
        await startCamera();
      } catch (e) {
        await db.addLog({ level:'error', message:`exportToCSV: ${e.message}` });
        showNotification(`‚ùå –û—à–∏–±–∫–∞: ${e.message}`, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function syncPendingScans() {
      if (!navigator.onLine) { updateSyncIndicator(); return; }
      try {
        const pending = await db.getPendingScans();
        if (!pending.length) { updateSyncIndicator(0); return; }

        const deviceId = localStorage.getItem('device_id') ||
          (function () {
            const id = 'dev-' + Math.random().toString(36).slice(2);
            localStorage.setItem('device_id', id);
            return id;
          })();

        const payload = pending.map(p => ({
          device_id: deviceId,
          sample: p.sample,
          well_name: p.well_name,
          block: p.block,
          type: p.type,
          scanned_at: p.scanned_at,
          scanned_by: p.scanned_by,
          local_id: p.id
        }));

        const res = await fetch(API_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);

        let serverResponse = {};
        try { serverResponse = await res.json(); } catch (_) {}
        const serverIds = serverResponse.server_ids || [];
        if (typeof serverResponse.total_on_server === 'number') {
          lastServerCount = serverResponse.total_on_server;
        }

        await db.markSynced(pending.map(p => p.id), serverIds);
        await refreshScans();
        await db.addLog({ level:'info', message:`sync ok: ${pending.length}` });
        showNotification(`‚úì –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${pending.length}`, 'success');
      } catch (e) {
        console.error('Sync error', e);
        await db.addLog({ level:'error', message:`syncPendingScans: ${e.message}` });
      } finally {
        updateSyncIndicator();
      }
    }

    async function updateSyncIndicator() {
      const indicator = document.getElementById('syncIndicator');
      const scans = allScans;
      const localCount = scans.length;
      const pendingCount = scans.filter(s => s.sync_status === 'pending').length;
      let text = `‚áÖ –ª–æ–∫–∞–ª—å–Ω–æ ${localCount}, –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ ${pendingCount}`;
      if (pendingCount > 0) {
        indicator.classList.add('pending');
        indicator.classList.remove('ok');
      } else {
        indicator.classList.add('ok');
        indicator.classList.remove('pending');
      }
      if (lastServerCount != null) text += ` / —Å–µ—Ä–≤–µ—Ä ${lastServerCount}`;
      indicator.textContent = text;
    }

    async function openDiagnostics() {
      const logs = await db.getLogs();
      const box = document.getElementById('diagnosticsLog');
      if (!logs.length) box.textContent = '–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç.';
      else {
        box.textContent = logs.map(l =>
          `${new Date(l.ts).toLocaleString('ru-RU')} [${l.level}]: ${l.message}`
        ).join('\n');
      }
      document.getElementById('diagnosticsModal').classList.add('active');
    }
    function closeDiagnostics() {
      document.getElementById('diagnosticsModal').classList.remove('active');
    }
    async function clearDiagnosticsLog() {
      await db.clearLogs();
      document.getElementById('diagnosticsLog').textContent = '–ñ—É—Ä–Ω–∞–ª –ø—É—Å—Ç.';
      showNotification('–ñ—É—Ä–Ω–∞–ª –æ—á–∏—â–µ–Ω', 'info');
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await db.init();
        await initBarcodeScanner();

        const userInput = document.getElementById('userNameInput');
        userInput.value = currentUser;
        userInput.addEventListener('change', () => {
          currentUser = userInput.value || '–û–ø–µ—Ä–∞—Ç–æ—Ä';
          localStorage.setItem('scan_user', currentUser);
        });

        const typeSelect = document.getElementById('typeSelect');
        const savedType = localStorage.getItem('scan_type');
        if (savedType) typeSelect.value = savedType;
        typeSelect.addEventListener('change', () => {
          localStorage.setItem('scan_type', typeSelect.value);
        });

        const blockInput = document.getElementById('blockInput');
        const savedBlock = localStorage.getItem('scan_block');
        if (savedBlock) blockInput.value = savedBlock;
        blockInput.addEventListener('change', () => {
          localStorage.setItem('scan_block', blockInput.value);
        });

        const updateConn = () => {
          const el = document.getElementById('connectionStatus');
          if (navigator.onLine) {
            el.textContent = '‚úÖ –û–Ω–ª–∞–π–Ω (–¥–∞–Ω–Ω—ã–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è)';
            syncPendingScans();
          } else {
            el.textContent = 'üî¥ –û—Ñ–ª–∞–π–Ω (–∑–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–µ–ª–µ—Ñ–æ–Ω–µ)';
          }
        };
        window.addEventListener('online', updateConn);
        window.addEventListener('offline', updateConn);
        updateConn();

        document.getElementById('sampleInput').addEventListener('keypress', e => {
          if (e.key === 'Enter') processScan();
        });

        await refreshScans();
        document.getElementById('sampleInput').focus();
      } catch (e) {
        console.error(e);
        await db.addLog({ level:'error', message:`init: ${e.message}` });
        showNotification('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏', 'error');
      }
    });

    setInterval(refreshScans, 30000);
  </script>
</body>
</html>
