<div class="page-duplicates">
  <header class="page-header">
    <h1>üîÑ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–∞–º–∏</h1>
  </header>

  <div class="content">
    <div class="card">
      <div class="card-header">‚ûï –°–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</div>
      <label style="display: block; margin-bottom: 8px;">–ö—Ä–∞—Ç–Ω–æ—Å—Ç—å:</label>
      <select id="duplicateRatio" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;">
        <option value="1:10">–ö–∞–∂–¥–∞—è 10-—è –ø—Ä–æ–±–∞ (1:10)</option>
        <option value="1:20">–ö–∞–∂–¥–∞—è 20-—è –ø—Ä–æ–±–∞ (1:20)</option>
        <option value="1:5">–ö–∞–∂–¥–∞—è 5-—è –ø—Ä–æ–±–∞ (1:5)</option>
      </select>
      <button class="btn btn-primary btn-block" onclick="createDuplicates()">–°–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
    </div>

    <div id="duplicatesList" class="duplicates-list">
      <div style="text-align: center; padding: 40px; color: #999;">
        <div style="font-size: 32px; margin-bottom: 12px;">‚è≥</div>
        <p>–ó–∞–≥—Ä—É–∑–∫–∞...</p>
      </div>
    </div>

    <div class="card">
      <div class="card-header">üì• –î–µ–π—Å—Ç–≤–∏—è</div>
      <button class="btn btn-secondary btn-block" onclick="exportDuplicates()">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ Excel</button>
      <button class="btn btn-danger btn-block" onclick="deletAllDuplicates()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã</button>
    </div>
  </div>
</div>

<style>
.page-duplicates { padding: 12px; }

.page-header {
  padding: 12px 0;
  border-bottom: 2px solid var(--primary-color);
  margin-bottom: 16px;
}

.page-header h1 {
  font-size: 24px;
  margin: 0;
}

.content {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.duplicates-list {
  background: white;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: var(--shadow);
}

.duplicate-item {
  padding: 12px;
  border-bottom: 1px solid #e0e0e0;
}

.duplicate-item:last-child {
  border-bottom: none;
}

.duplicate-id {
  font-weight: 600;
  color: var(--primary-color);
}

.duplicate-info {
  font-size: 12px;
  color: #666;
  margin-top: 4px;
}

.duplicate-actions {
  margin-top: 8px;
  display: flex;
  gap: 8px;
}

.duplicate-actions button {
  flex: 1;
  padding: 6px 12px;
  font-size: 12px;
}
</style>

<script>
// –ó–∞–≥—Ä—É–∑–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
(async () => {
  try {
    const duplicates = await db.getAllDuplicates();
    renderDuplicates(duplicates);
  } catch (error) {
    console.error('Error loading duplicates:', error);
  }
})();

function renderDuplicates(duplicates) {
  const list = document.getElementById('duplicatesList');
  
  if (duplicates.length === 0) {
    list.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #999;">
        <div style="font-size: 32px; margin-bottom: 12px;">üì≠</div>
        <p>–ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤. –°–æ–∑–¥–∞–π—Ç–µ –∏—Ö –≤—ã—à–µ</p>
      </div>
    `;
    return;
  }

  list.innerHTML = duplicates.map(dup => `
    <div class="duplicate-item">
      <div class="duplicate-id">${dup.duplicate_id}</div>
      <div class="duplicate-info">
        <p><strong>–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–±–∞:</strong> ${dup.original_sample_id}</p>
        <p><strong>–ö—Ä–∞—Ç–Ω–æ—Å—Ç—å:</strong> ${dup.duplicate_ratio}</p>
        <p><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${formatDate(dup.created_at)}</p>
        <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${dup.analysis_status === 'analyzed' ? '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'}</p>
      </div>
      <div class="duplicate-actions">
        <button class="btn btn-secondary" onclick="deleteDuplicate('${dup.duplicate_id}')">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
      </div>
    </div>
  `).join('');
}

async function createDuplicates() {
  const ratio = document.getElementById('duplicateRatio').value;
  await generateDuplicates(ratio);
  
  setTimeout(async () => {
    const duplicates = await db.getAllDuplicates();
    renderDuplicates(duplicates);
  }, 500);
}

async function deleteDuplicate(duplicateId) {
  if (confirm(`–£–¥–∞–ª–∏—Ç—å –¥—É–±–ª–∏–∫–∞—Ç ${duplicateId}?`)) {
    try {
      await db.deleteDuplicate(duplicateId);
      const duplicates = await db.getAllDuplicates();
      renderDuplicates(duplicates);
      showNotification('‚úì –î—É–±–ª–∏–∫–∞—Ç —É–¥–∞–ª–µ–Ω', 'success');
    } catch (error) {
      showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
    }
  }
}

async function deletAllDuplicates() {
  if (confirm('‚ùå –£–¥–∞–ª–∏—Ç—å –í–°–ï –¥—É–±–ª–∏–∫–∞—Ç—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!')) {
    try {
      const duplicates = await db.getAllDuplicates();
      for (const dup of duplicates) {
        await db.deleteDuplicate(dup.duplicate_id);
      }
      renderDuplicates([]);
      showNotification('‚úì –í—Å–µ –¥—É–±–ª–∏–∫–∞—Ç—ã —É–¥–∞–ª–µ–Ω—ã', 'success');
    } catch (error) {
      showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
    }
  }
}

async function exportDuplicates() {
  try {
    showLoading(true);
    
    const duplicates = await db.getAllDuplicates();
    
    if (duplicates.length === 0) {
      showNotification('‚ö†Ô∏è –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
      return;
    }

    const data = duplicates.map(dup => ({
      'ID –¥—É–±–ª–∏–∫–∞—Ç–∞': dup.duplicate_id,
      'ID –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–±—ã': dup.original_sample_id,
      '–ö—Ä–∞—Ç–Ω–æ—Å—Ç—å': dup.duplicate_ratio,
      '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è': formatDate(dup.created_at),
      '–°—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞': dup.analysis_status === 'analyzed' ? '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–î—É–±–ª–∏–∫–∞—Ç—ã');

    const fileName = `–î—É–±–ª–∏–∫–∞—Ç—ã_${new Date().toISOString().split('T')}.xlsx`;
    XLSX.writeFile(wb, fileName);

    showNotification('‚úì –§–∞–π–ª —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', 'success');
    
  } catch (error) {
    showNotification(`‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}
</script>
