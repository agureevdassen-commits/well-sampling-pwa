<div class="page-scanner">
  <header class="page-header">
    <h1>üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h1>
  </header>

  <div class="content">
    <div class="scanner-preview" id="scannerPreview">
      <div style="text-align: center; padding: 40px; background: #f0f0f0; border-radius: 8px;">
        <div style="font-size: 48px; margin-bottom: 12px;">üì∑</div>
        <p>–í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤—Ä—É—á–Ω—É—é</p>
      </div>
    </div>

    <div class="card">
      <div class="card-header">üìù –í–≤–æ–¥ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞</div>
      <input type="text" id="barcodeInput" placeholder="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px;">
      <button class="btn btn-primary btn-block" onclick="processScan()">‚úì –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>

    <div class="card">
      <div class="card-header" id="resultHeader">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
      <div id="resultContent" style="text-align: center; color: #999; padding: 20px;">
        –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–∫–≤–∞–∂–∏–Ω—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å
      </div>
    </div>

    <div class="card">
      <div class="card-header">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</div>
      <div class="flex-between mb-2">
        <span>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ —Å–µ–≥–æ–¥–Ω—è:</span>
        <strong id="scannedToday">0</strong>
      </div>
      <div class="flex-between mb-2">
        <span>–í—Å–µ–≥–æ –æ–ø—Ä–æ–±–æ–≤–∞–Ω–æ:</span>
        <strong id="totalScanned">0</strong>
      </div>
    </div>
  </div>
</div>

<style>
.page-scanner { padding: 12px; }

.page-header {
  padding: 12px 0;
  border-bottom: 2px solid var(--primary-color);
  margin-bottom: 16px;
}

.page-header h1 {
  font-size: 24px;
  margin: 0;
}

.content {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.scanner-preview {
  margin-bottom: 12px;
}

#barcodeInput {
  font-size: 18px !important;
  text-align: center;
}

.result-success {
  background: #d4edda;
  color: #155724;
  padding: 12px;
  border-radius: 6px;
}

.result-error {
  background: #f8d7da;
  color: #721c24;
  padding: 12px;
  border-radius: 6px;
}
</style>

<script>
// –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
document.getElementById('barcodeInput').focus();

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
(async () => {
  const stats = await db.getStatistics();
  document.getElementById('totalScanned').textContent = stats.sampledWells;

  const today = new Date().toISOString().split('T');
  const logs = await db.getLogs();
  const todayLogs = logs.filter(log => 
    new Date(log.timestamp).toISOString().split('T') === today
  );
  document.getElementById('scannedToday').textContent = todayLogs.length;
})();

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
async function processScan() {
  const barcode = document.getElementById('barcodeInput').value.trim();
  
  if (!barcode) {
    showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —à—Ç—Ä–∏—Ö–∫–æ–¥', 'warning');
    return;
  }

  try {
    showLoading(true);

    const wells = await db.getAllWells();
    const well = wells.find(w => w.well_id === barcode || w.barcode === barcode);

    if (!well) {
      showNotification(`‚ùå –°–∫–≤–∞–∂–∏–Ω–∞ ${barcode} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞`, 'error');
      document.getElementById('barcodeInput').value = '';
      document.getElementById('barcodeInput').focus();
      return;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
    await db.updateWellStatus(well.well_id, 'sampled', currentUser);
    await db.addLog(well.well_id, well.well_name, currentUser, 'scan');

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ localStorage
    const allWells = await db.getAllWells();
    localStorage.setItem('wells', JSON.stringify(allWells));

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    const resultContent = document.getElementById('resultContent');
    resultContent.innerHTML = `
      <div class="result-success">
        <strong>‚úì –£—Å–ø–µ—à–Ω–æ!</strong><br>
        –°–∫–≤–∞–∂–∏–Ω–∞: ${well.well_name}<br>
        ID: ${well.well_id}<br>
        –°—Ç–∞—Ç—É—Å: –û–ø—Ä–æ–±–æ–≤–∞–Ω–∞
      </div>
    `;
    document.getElementById('resultHeader').textContent = '‚úì –†–µ–∑—É–ª—å—Ç–∞—Ç';

    // –ó–≤—É–∫–æ–≤–∞—è –∏ —Ç–∞–∫—Ç–∏–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
    playBeep();
    if ('vibrate' in navigator) {
      navigator.vibrate([100, 50, 100]);
    }

    showNotification(`‚úì ${well.well_name} –æ—Ç–º–µ—á–µ–Ω–∞`, 'success');

    // –û—á–∏—Å—Ç–∫–∞ –≤–≤–æ–¥–∞
    setTimeout(() => {
      document.getElementById('barcodeInput').value = '';
      document.getElementById('barcodeInput').focus();
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      (async () => {
        const stats = await db.getStatistics();
        document.getElementById('totalScanned').textContent = stats.sampledWells;
        
        const today = new Date().toISOString().split('T');
        const logs = await db.getLogs();
        const todayLogs = logs.filter(log => 
          new Date(log.timestamp).toISOString().split('T') === today
        );
        document.getElementById('scannedToday').textContent = todayLogs.length;
      })();
    }, 1000);

  } catch (error) {
    console.error('Scan error:', error);
    showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

// –ó–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª
function playBeep() {
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();

  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);

  oscillator.frequency.value = 800;
  oscillator.type = 'sine';

  gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);

  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.1);
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter
document.getElementById('barcodeInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    processScan();
  }
});
</script>
