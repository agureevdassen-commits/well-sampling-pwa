<div class="page-export">
  <header class="page-header">
    <h1>üì• –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</h1>
  </header>

  <div class="content">
    <div class="card">
      <div class="card-header">üìä –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Å–ø–æ—Ä—Ç –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è</div>
      <p style="font-size: 12px; color: #666; margin-bottom: 12px;">–°–∫–∞—á–∞—Ç—å –ø–æ–ª–Ω—ã–π –ø–∞—Å–ø–æ—Ä—Ç –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏—è —Å–∫–≤–∞–∂–∏–Ω —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ–ø—Ä–æ–±–æ–≤–∞–Ω–∏–∏</p>
      <button class="btn btn-primary btn-block" onclick="exportPassport()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
    </div>

    <div class="card">
      <div class="card-header">üîÑ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã</div>
      <p style="font-size: 12px; color: #666; margin-bottom: 12px;">–°–∫–∞—á–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö –ø—Ä–æ–± –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏—é</p>
      <button class="btn btn-primary btn-block" onclick="exportDuplicates()">üì• –≠–∫—Å–ø–æ—Ä—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤</button>
    </div>

    <div class="card">
      <div class="card-header">üìã –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∂—É—Ä–Ω–∞–ª –¥–µ–π—Å—Ç–≤–∏–π</div>
      <p style="font-size: 12px; color: #666; margin-bottom: 12px;">–°–∫–∞—á–∞—Ç—å –ø–æ–ª–Ω—ã–π –∂—É—Ä–Ω–∞–ª –≤—Å–µ—Ö —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–π –∏ –¥–µ–π—Å—Ç–≤–∏–π</p>
      <button class="btn btn-primary btn-block" onclick="exportLogs()">üì• –≠–∫—Å–ø–æ—Ä—Ç –ª–æ–≥–æ–≤</button>
    </div>

    <div class="card">
      <div class="card-header">üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</div>
      <p style="font-size: 12px; color: #666; margin-bottom: 12px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è</p>
      <button class="btn btn-secondary btn-block" onclick="backupData()">üíæ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</button>
      <label style="display: block; margin-top: 12px;">–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é:</label>
      <input type="file" id="backupFile" accept=".json" style="width: 100%; margin: 8px 0;">
      <button class="btn btn-secondary btn-block" onclick="restoreData()">üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ —Ñ–∞–π–ª–∞</button>
    </div>

    <div class="card">
      <div class="card-header">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞</div>
      <div id="exportStats" style="font-size: 12px; color: #666;">
        <p id="totalWellsExport">–í—Å–µ–≥–æ —Å–∫–≤–∞–∂–∏–Ω: 0</p>
        <p id="sampledWellsExport">–û–ø—Ä–æ–±–æ–≤–∞–Ω–æ: 0</p>
        <p id="duplicatesExport">–î—É–±–ª–∏–∫–∞—Ç–æ–≤: 0</p>
        <p id="logsExport">–õ–æ–≥–æ–≤: 0</p>
      </div>
    </div>
  </div>
</div>

<style>
.page-export { padding: 12px; }

.page-header {
  padding: 12px 0;
  border-bottom: 2px solid var(--primary-color);
  margin-bottom: 16px;
}

.page-header h1 {
  font-size: 24px;
  margin: 0;
}

.content {
  display: flex;
  flex-direction: column;
  gap: 12px;
}
</style>

<script>
// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
(async () => {
  try {
    const wells = await db.getAllWells();
    const duplicates = await db.getAllDuplicates();
    const logs = await db.getLogs(1000);
    const sampled = wells.filter(w => w.sampling_status === 'sampled').length;

    document.getElementById('totalWellsExport').textContent = `–í—Å–µ–≥–æ —Å–∫–≤–∞–∂–∏–Ω: ${wells.length}`;
    document.getElementById('sampledWellsExport').textContent = `–û–ø—Ä–æ–±–æ–≤–∞–Ω–æ: ${sampled}`;
    document.getElementById('duplicatesExport').textContent = `–î—É–±–ª–∏–∫–∞—Ç–æ–≤: ${duplicates.length}`;
    document.getElementById('logsExport').textContent = `–õ–æ–≥–æ–≤: ${logs.length}`;
  } catch (error) {
    console.error('Error loading export stats:', error);
  }
})();

async function exportPassport() {
  await exportToExcel();
}

async function exportDuplicates() {
  try {
    showLoading(true);
    
    const duplicates = await db.getAllDuplicates();
    
    if (duplicates.length === 0) {
      showNotification('‚ö†Ô∏è –ù–µ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
      return;
    }

    const data = duplicates.map(dup => ({
      'ID –¥—É–±–ª–∏–∫–∞—Ç–∞': dup.duplicate_id,
      'ID –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–±—ã': dup.original_sample_id,
      '–ö—Ä–∞—Ç–Ω–æ—Å—Ç—å': dup.duplicate_ratio,
      '–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è': formatDate(dup.created_at),
      '–°—Ç–∞—Ç—É—Å –∞–Ω–∞–ª–∏–∑–∞': dup.analysis_status === 'analyzed' ? '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω' : '–ù–µ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω'
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–î—É–±–ª–∏–∫–∞—Ç—ã');

    const fileName = `–î—É–±–ª–∏–∫–∞—Ç—ã_${new Date().toISOString().split('T')}.xlsx`;
    XLSX.writeFile(wb, fileName);

    showNotification('‚úì –î—É–±–ª–∏–∫–∞—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
    
  } catch (error) {
    showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

async function exportLogs() {
  try {
    showLoading(true);
    
    const logs = await db.getLogs(1000);
    
    if (logs.length === 0) {
      showNotification('‚ö†Ô∏è –ù–µ—Ç –ª–æ–≥–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning');
      return;
    }

    const data = logs.map(log => ({
      'ID —Å–∫–≤–∞–∂–∏–Ω—ã': log.wellId,
      '–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–≤–∞–∂–∏–Ω—ã': log.wellName,
      '–°–æ—Ç—Ä—É–¥–Ω–∏–∫': log.userName,
      '–î–µ–π—Å—Ç–≤–∏–µ': log.action,
      '–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è': formatDate(log.timestamp)
    }));

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–õ–æ–≥–∏');

    const fileName = `–õ–æ–≥–∏_${new Date().toISOString().split('T')}.xlsx`;
    XLSX.writeFile(wb, fileName);

    showNotification('‚úì –õ–æ–≥–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã', 'success');
    
  } catch (error) {
    showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

async function backupData() {
  try {
    showLoading(true);
    
    const backup = await db.exportToJSON();
    
    const dataStr = JSON.stringify(backup, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `backup_${new Date().toISOString().split('T')}.json`;
    link.click();
    URL.revokeObjectURL(url);

    showNotification('‚úì –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞', 'success');
    
  } catch (error) {
    showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
  } finally {
    showLoading(false);
  }
}

async function restoreData() {
  const file = document.getElementById('backupFile').files;
  
  if (!file) {
    showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è', 'warning');
    return;
  }

  if (!confirm('‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ! –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
    return;
  }

  try {
    showLoading(true);

    const reader = new FileReader();
    
    reader.onload = async (e) => {
      try {
        const backup = JSON.parse(e.target.result);
        await db.importFromJSON(backup);
        showNotification('‚úì –î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã', 'success');
        location.reload();
      } catch (error) {
        showNotification(`‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ${error.message}`, 'error');
      } finally {
        showLoading(false);
      }
    };

    reader.readAsText(file);

  } catch (error) {
    showNotification(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`, 'error');
    showLoading(false);
  }
}
</script>
